<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Xuxx,Galileo,blog" />
    <meta name="generator" content="Maverick 1.0" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="Xuxx的个人博客。 &raquo; RSS 2.0" href="/Xuxx_Blogs/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Xuxx的个人博客。 &raquo; ATOM 1.0" href="/Xuxx_Blogs/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/galileo-ec40839efa.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/ExSearch-182e5a8868.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/c81ed14a4d2de0cd522ae0cb4e8b941b.json"
        }
    </script>
    
<title>Spring Boot整合Security - Xuxx的个人博客。</title>
<meta name="author" content="Xuxx" />
<meta name="description" content="笔记" />
<meta property="og:title" content="Spring Boot整合Security - Xuxx的个人博客。" />
<meta property="og:description" content="笔记" />
<meta property="og:site_name" content="Xuxx的个人博客。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Xuxx_Blogs/archives/bj21/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2020-05-18T15:10:00-00.00" />
<meta name="twitter:title" content="Spring Boot整合Security - Xuxx的个人博客。" />
<meta name="twitter:description" content="笔记" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-logo">
                        <a href="/Xuxx_Blogs/" target="_self">
                            <img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/logo.png" alt="Xuxx的个人博客。">
                        </a>
                    </aside>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/Xuxx_Blogs/">Xuxx的个人博客。</a></h1>
                        <p>坚持有效行动，改变自然发生——致自己。</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/Xuxx_Blogs/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Xuxx_Blogs/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Xuxx_Blogs/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                    <nav class="social-links">
                        <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/xuxx3309" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/QQ1820582487" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">Spring Boot整合Security</h1>
            <span class="ga-post_meta ga-mono">
                <span>Xuxx</span>
                <time>
                    2020-05-18
                </time>
                
                in <a no-style class="category" href="/Xuxx_Blogs/category/笔记/">
                    笔记
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <h2>1.Spring Security入门</h2>
<h3>1.Spring Security初体验</h3>
<h4>1.引入依赖</h4>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<h4>2.Controller</h4>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="p">{</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello Security!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h4>3.测试</h4>
<p>此时启动项目，访问<code>http://localhost:8080/hello</code>，此时会发现，会自动重定向到<code>http://localhost:8080/login</code>,也就是说<code>hello</code>接口被<strong>Security</strong>保护起来了，不能直接访问了。</p>
<p><figure class="pswp-item" style="flex: 84.96993987975952" data-width="848" data-height="499"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/5877e03f11eb9a6176b7ea969491bd21.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 155.64334085778782" data-width="1379" data-height="443"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/97a95c9aaf8623d9a33514ae9803b5ed.png" alt="" /></figure></p>
<p>输入用户名（user）和密码（每次生成的密码都不一样）（实际上就是UUID），登录后便能访问接口了。</p>
<h3>2.手动配置Security用户和密码</h3>
<h4>1.第一种：在配置文件中配置</h4>
<div class="highlight"><pre><span></span><span class="na">spring.security.user.name</span><span class="o">=</span><span class="s">xuxx</span>
<span class="na">spring.security.user.password</span><span class="o">=</span><span class="s">123</span>
<span class="na">spring.security.user.roles</span><span class="o">=</span><span class="s">admin</span>
</pre></div>
<p>配置后，Security便不会再生成密码了，当然也不会在控制台打印了，所以此时再登录便只能使用配置的用户（xuxx）和密码(123)了。</p>
<h4>2.第二种：编写配置类</h4>
<div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">    Spring5之后密码必须要加密，所以要配置PasswordEncoder</span>
<span class="cm">    */</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//密码编码器，密码不加密，NoOpPasswordEncoder以过期</span>
        <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//基于内存的认证</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;xuxx&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h2>2.Spring Security进阶</h2>
<p>以上的拦截规则是除了Security的方法，会拦截其他所有的请求，为了实现多种权限配置方案，所以需要了解<code>HttpSecurity</code>的配置。</p>
<h3>1.HttpSecurity的配置</h3>
<p>还是在之前的配置类中进行配置</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.NoOpPasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>

    <span class="cm">/*</span>
<span class="cm">    Spring5之后密码必须要加密，所以必须配置PasswordEncoder</span>
<span class="cm">    */</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//密码编码器，密码不加密，NoOpPasswordEncoder以过期.</span>
        <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//基于内存的认证</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;xuxx&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="c1">//开启授权请求配置</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">)</span><span class="c1">//要拦截的请求路径</span>
                <span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(一个)</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/users/**&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(其中一个)</span>
               <span class="c1">//.antMatchers().access(&quot;hasAnyRole(&#39;admin&#39;,&#39;user&#39;)&quot;)//和上面效果一样</span>
                <span class="p">.</span><span class="na">anyRequest</span><span class="p">()</span><span class="c1">//剩下的其他的请求</span>
                <span class="p">.</span><span class="na">authenticated</span><span class="p">()</span><span class="c1">//认证后访问</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">formLogin</span><span class="p">()</span><span class="c1">//表单登录</span>
                <span class="p">.</span><span class="na">loginProcessingUrl</span><span class="p">(</span><span class="s">&quot;/doLogin&quot;</span><span class="p">)</span><span class="c1">//进行登录处理的Url</span>
                <span class="p">.</span><span class="na">permitAll</span><span class="p">()</span><span class="c1">//允许登录相关的所有请求</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">csrf</span><span class="p">()</span>
                <span class="p">.</span><span class="na">disable</span><span class="p">();</span><span class="c1">//方便测试，关闭csrf(跨域)保护</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>在Controller中添加两个接口</p>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="p">{</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello Security!&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;admin/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">admin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello admin用户&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;user/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">users</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello user用户&quot;</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>测试结果:</p>
<p>使用<code>xuxx</code>登录时，可以访问定义的三个接口</p>
<p>使用<code>test</code>登录时，只可以访问<code>hello</code>和<code>user/hello</code>,访问<code>admin/hello</code>时报错403(权限不足)</p>
<p><figure class="pswp-item" style="flex: 143.27731092436974" data-width="1023" data-height="357"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/00a4573ecc8db9f540cd8db60ded102e.png" alt="" /></figure>
此时发现配置的<code>loginProcessingUrl("/doLogin")</code>还没用上，那么就用一用，打开<strong>Insomnia</strong></p>
<p>使用<strong>POST</strong>方式访问<code>http://localhost:8080/doLogin?username=xuxx&amp;password=123</code></p>
<p><figure class="pswp-item" style="flex: 171.39423076923077" data-width="1426" data-height="416"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/ceed167930d7eaa6af59a87583b65528.png" alt="" /></figure></p>
<p>虽然报了<code>404</code>,当时其实已经登录成功了，404只是因为Security登录成功后往<code>http://localhost:8080/</code>跳转，但是这个路径下没有东西，所以404了，不信的话再访问一下配置的接口，成功了。</p>
<p><figure class="pswp-item" style="flex: 168.59756097560975" data-width="1106" data-height="328"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/37bb3f52d1ff6928719118c69c88d7fa.png" alt="" /></figure></p>
<h3>2.登录表单的详细配置</h3>
<p>属于HttpSecurity中的配置</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.NoOpPasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationFailureHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationSuccessHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.logout.LogoutSuccessHandler</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.PrintWriter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>

    <span class="cm">/*</span>
<span class="cm">    Spring5之后密码必须要加密，所以必须配置PasswordEncoder</span>
<span class="cm">    */</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//密码编码器，密码不加密，NoOpPasswordEncoder以过期.</span>
        <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//基于内存的认证</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;xuxx&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="c1">//开启授权请求配置</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">)</span><span class="c1">//要拦截的请求路径</span>
                <span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(一个)</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/users/**&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(其中一个)</span>
<span class="c1">//                .antMatchers().access(&quot;hasAnyRole(&#39;admin&#39;,&#39;user&#39;)&quot;)//和上面效果一样</span>
                <span class="p">.</span><span class="na">anyRequest</span><span class="p">()</span><span class="c1">//剩下的其他请求</span>
                <span class="p">.</span><span class="na">authenticated</span><span class="p">()</span><span class="c1">//认证后访问</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">formLogin</span><span class="p">()</span><span class="c1">//表单登录</span>
                <span class="p">.</span><span class="na">loginProcessingUrl</span><span class="p">(</span><span class="s">&quot;/doLogin&quot;</span><span class="p">)</span><span class="c1">//进行登录处理的Url</span>
                <span class="p">.</span><span class="na">loginPage</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span><span class="c1">//登录页面的Url，可以配置自己的登录页面</span>
                <span class="p">.</span><span class="na">usernameParameter</span><span class="p">(</span><span class="s">&quot;uname&quot;</span><span class="p">)</span><span class="c1">//用户名的key，默认username</span>
                <span class="p">.</span><span class="na">passwordParameter</span><span class="p">(</span><span class="s">&quot;pass&quot;</span><span class="p">)</span><span class="c1">//密码的key，默认password</span>
<span class="c1">//                .successForwardUrl(&quot;/index&quot;)//登录成功自动跳转，一般用于前后端不分</span>
                <span class="p">.</span><span class="na">successHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationSuccessHandler</span><span class="p">()</span> <span class="p">{</span><span class="c1">//登录成功的处理，一般用于前后端分离</span>
                    <span class="c1">//authentication中保存了登录成功的用户信息</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span>
                                                        <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
                        <span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json;charset=utf-8&quot;</span><span class="p">);</span>
                        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">());</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">().</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">})</span>
<span class="c1">//                .failureForwardUrl(&quot;/login_error&quot;)//登录失败自动跳转</span>
                <span class="p">.</span><span class="na">failureHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationFailureHandler</span><span class="p">()</span> <span class="p">{</span><span class="c1">//登录失败的处理</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">AuthenticationException</span> <span class="n">exception</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
                        <span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json;charset=utf-8&quot;</span><span class="p">);</span>
                        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">401</span><span class="p">);</span>
                        <span class="c1">//根据异常类型返回错误信息，相关异常可以查看AuthenticationException的子类</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">LockedException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户被锁定，登录失败！&quot;</span><span class="p">);</span>
                        <span class="c1">//Security屏蔽了UsernameNotFoundException，抛出UsernameNotFoundException也会变成BadCredentialsException，防止撞库</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">BadCredentialsException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;用户名或密码输入错误，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">DisabledException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户被禁用，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">AccountExpiredException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户以过期，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">CredentialsExpiredException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;密码以过期，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;因未知原因登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">().</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="na">permitAll</span><span class="p">()</span><span class="c1">//允许登录相关的所有请求</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">csrf</span><span class="p">()</span>
                <span class="p">.</span><span class="na">disable</span><span class="p">();</span><span class="c1">//为了方便测试，先关闭csrf(跨域)保护</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>测试：</p>
<p><figure class="pswp-item" style="flex: 113.07448494453249" data-width="1427" data-height="631"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/a937e5cdcff349785d05700089ec0759.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 176.41752577319588" data-width="1369" data-height="388"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/54befa4ddbae1f6f2821eb3d02984f81.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 151.43805309734512" data-width="1369" data-height="452"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/3017b9e7b9284154162dae6316bc4f61.png" alt="" /></figure></p>
<h3>3.注销登录配置</h3>
<p>与登录表单配置一样，还是属于HttpSecurity中的配置</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.AuthenticationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.NoOpPasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationFailureHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.AuthenticationSuccessHandler</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.logout.LogoutSuccessHandler</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.PrintWriter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>

    <span class="cm">/*</span>
<span class="cm">    Spring5之后密码必须要加密，所以必须配置PasswordEncoder</span>
<span class="cm">    */</span>
    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//密码编码器，密码不加密，NoOpPasswordEncoder以过期.</span>
        <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="c1">//基于内存的认证</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;xuxx&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="c1">//开启授权请求配置</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">)</span><span class="c1">//要拦截的请求路径</span>
                <span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(一个)</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/user/**&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">hasAnyRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">)</span><span class="c1">//所需要的角色(其中一个)</span>
<span class="c1">//                .antMatchers().access(&quot;hasAnyRole(&#39;admin&#39;,&#39;user&#39;)&quot;)//和上面效果一样</span>
                <span class="p">.</span><span class="na">anyRequest</span><span class="p">()</span><span class="c1">//剩下的其他请求</span>
                <span class="p">.</span><span class="na">authenticated</span><span class="p">()</span><span class="c1">//认证后访问</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">formLogin</span><span class="p">()</span><span class="c1">//表单登录</span>
                <span class="p">.</span><span class="na">loginProcessingUrl</span><span class="p">(</span><span class="s">&quot;/doLogin&quot;</span><span class="p">)</span><span class="c1">//进行登录处理的Url</span>
<span class="c1">//                .loginPage(&quot;/login&quot;)//登录页面的Url，可以配置自己的登录页面</span>
<span class="c1">//                .usernameParameter(&quot;uname&quot;)//用户名的key，默认username</span>
<span class="c1">//                .passwordParameter(&quot;pass&quot;)//密码的key，默认password</span>
<span class="c1">//                .successForwardUrl(&quot;/index&quot;)//登录成功自动跳转，一般用于前后端不分</span>
                <span class="p">.</span><span class="na">successHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationSuccessHandler</span><span class="p">()</span> <span class="p">{</span><span class="c1">//登录成功的处理，一般用于前后端分离</span>
                    <span class="c1">//authentication中保存了登录成功的用户信息</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationSuccess</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span>
                                                        <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
                        <span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json;charset=utf-8&quot;</span><span class="p">);</span>
                        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">());</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">().</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">})</span>
<span class="c1">//                .failureForwardUrl(&quot;/login_error&quot;)//登录失败自动跳转</span>
                <span class="p">.</span><span class="na">failureHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthenticationFailureHandler</span><span class="p">()</span> <span class="p">{</span><span class="c1">//登录失败的处理</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAuthenticationFailure</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">AuthenticationException</span> <span class="n">exception</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
                        <span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json;charset=utf-8&quot;</span><span class="p">);</span>
                        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">401</span><span class="p">);</span>
                        <span class="c1">//根据异常类型返回错误信息，相关异常可以查看AuthenticationException的子类</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">LockedException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户被锁定，登录失败！&quot;</span><span class="p">);</span>
                        <span class="c1">//Security屏蔽了UsernameNotFoundException，抛出UsernameNotFoundException也会变成BadCredentialsException，防止撞库</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">BadCredentialsException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;用户名或密码输入错误，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">DisabledException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户被禁用，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">AccountExpiredException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;账户以过期，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">instanceof</span> <span class="n">CredentialsExpiredException</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;密码以过期，登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;因未知原因登录失败！&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">().</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="na">permitAll</span><span class="p">()</span><span class="c1">//允许登录相关的所有请求</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">logout</span><span class="p">()</span><span class="c1">//注销登录</span>
                <span class="p">.</span><span class="na">logoutUrl</span><span class="p">(</span><span class="s">&quot;/logout&quot;</span><span class="p">)</span>
                <span class="c1">//.logoutSuccessUrl(&quot;/login&quot;)//注销成功后自动跳转</span>
                <span class="p">.</span><span class="na">logoutSuccessHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">LogoutSuccessHandler</span><span class="p">()</span> <span class="p">{</span><span class="c1">//注销成功的回调</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutSuccess</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="n">Authentication</span> <span class="n">authentication</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">ServletException</span> <span class="p">{</span>
                        <span class="n">response</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="s">&quot;application/json;charset=utf-8&quot;</span><span class="p">);</span>
                        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">();</span>
                        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
                        <span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;msg&quot;</span><span class="p">,</span> <span class="s">&quot;注销成功&quot;</span><span class="p">);</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="p">().</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
                        <span class="n">out</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">csrf</span><span class="p">()</span>
                <span class="p">.</span><span class="na">disable</span><span class="p">();</span><span class="c1">//为了方便测试，先关闭csrf(跨域)保护</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>测试：先登录，再访问<code>http://localhost:8080/logout</code>(GET，POST都行)</p>
<p><figure class="pswp-item" style="flex: 173.35164835164835" data-width="1262" data-height="364"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/bbf064a6437ce54c8ebd71d23c376a90.png" alt="" /></figure></p>
<h3>4.多个HttpSecurity</h3>
<p><strong>要先去除上面配置的单个的HttpSecurity</strong></p>

<pre><code>package com.xuxx.security.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.crypto.password.NoOpPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

/**
 * 多个Http Security的配置
 */
@Configuration
public class MultiHttpSecurity {
    @Bean
    PasswordEncoder passwordEncoder() {
        return NoOpPasswordEncoder.getInstance();
    }

    //多个Http Security可以共享
    @Autowired
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
                .withUser("xuxx").password("123").roles("admin")
                .and()
                .withUser("test").password("123").roles("user");
    }

    @Configuration
    @Order(1)//存在多个相同的bean时就存在优先级的问题
    public static class AdminSecurity extends WebSecurityConfigurerAdapter {
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            //只会拦截符合/admin/**的所有请求
            http.antMatcher("/admin/**").authorizeRequests().anyRequest().hasRole("admin");
        }
    }

    @Configuration
    //@Order//不配置order时是优先级最低的,2的31次方-1
    public static class OtherSecurity extends WebSecurityConfigurerAdapter {
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            http.authorizeRequests().anyRequest().authenticated()
                    .and()
                    .formLogin()
                    .loginProcessingUrl("/doLogin")
                    .permitAll()
                    .and()
                    .csrf()
                    .disable();
        }
    }
}</code></pre>
<p>测试</p>
<p><figure class="pswp-item" style="flex: 144.4560669456067" data-width="1381" data-height="478"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/07db653d0c46ec7c1165c0462c054e8b.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 206.1889250814332" data-width="1266" data-height="307"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/949b1e2322ca9ed0d0934f611210ba69.png" alt="" /></figure></p>
<p>因为使用<code>xuxx</code>登录了，访问其他接口也是可以的。</p>
<p>再使用<code>test</code>登录试试</p>
<p><figure class="pswp-item" style="flex: 177.44845360824743" data-width="1377" data-height="388"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/6210caa94b4e07df1a2f81d07cdd00e4.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 211.75496688741723" data-width="1279" data-height="302"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/9fa75eb00fa6d1186b864a45784f11e3.png" alt="" /></figure></p>
<h3>5.密码加密</h3>
<p>上面的例子都是使用的明文密码，这是非常不安全的，所以还是加密下吧。</p>
<p>由Spring Security提供的BCryptPasswordEncoder采用SHA-256+随机盐+密钥对明文密码进行加密。SHA系列是哈希算法，不是加密算法，使用加密算法意味着可以解密（这个与编码/解码一样），但是采用哈希处理，其过程是不可逆的。</p>
<ol>
<li><p>加密(encode)：注册用户时，使用SHA-256+随机盐+密钥把用户输入的密码进行哈希处理，得到密码的哈希值，然后将其存入数据库中。</p>
</li>
<li><p>密码匹配(matches)：用户登录时，密码匹配阶段并没有进行密码解密（因为密码经过Hash处理，是不可逆的），而是使用相同的算法把用户输入的密码进行哈希处理，得到密码的hash值，然后将其与从数据库中查询到的密码哈希值进行比较。如果两者相同，说明用户输入的密码正确。</p>
</li>
</ol>
<p>这正是为什么处理密码时要用哈希算法，而不用加密算法。因为这样处理后，即使数据库泄漏，黑客也很难破解密码（只能用彩虹表）。</p>
<p>先看看效果</p>
<div class="highlight"><pre><span></span><span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">SecurityApplicationTests</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//构造方法可以传入强度(密钥迭代次数)默认为10次</span>
            <span class="n">BCryptPasswordEncoder</span> <span class="n">passwordEncoder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">passwordEncoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>虽然只是加密<strong>123</strong>,但是每次的结果都不同。</p>

<pre><code>$2a$10$cGdG1DACEh2t4AekoCiZ1OyJWHbT4N3kFtSGDg85XNjn6SFb2cDYG
$2a$10$nFCK0tHN3lDXCi8ptZd64usYbxU8gKTRiOSTZ8o1uvfEqWB5C9fwu
$2a$10$1uP74goNp/gwHZehn3Lqfeyz51BnLGCG5xg63zRnIDTZoMa7lJeje
$2a$10$N4CdezU05HFf05cK.eTh3uSuzS6NV1gODD9h3nNdmK71Fp81mYMwy
$2a$10$/tdqqGfDrHh3Jx6IbGOLeu7hJ86IVYljImUDfrzQP5EsVbx70Sy/q
$2a$10$bK6ItziD2vcMdvgiUZ5PkudaMxkswnz7RhEKnCsmhl/bGFWGnA0XG
$2a$10$MIBXmxMyQFtrQ4awOtELXOBAvE8d1B54gCsv0kG6mPM9EooY35MPq
$2a$10$0zCKSIqQVMhJM8OGs/35tOne2EZK/oj.v6LXjkH1FlYPNRdipjdhu
$2a$10$9x/3T.nAUM1YOWhhR1xORuZEbRad5mc3.Rh6MBE2pPkNGUIUG9mYa
$2a$10$xprjfwyAndoCSO3uFjS5ce7lLslmnKo7fNo/jOuEifN4PEZjy8ZTu</code></pre>
<p>简单使用一下，改造上面的<strong>MultiHttpSecurity</strong>，将明文密码换成使用<strong>BCryptPasswordEncoder</strong>生成的加密后的密码，当然，要注入的<strong>PasswordEncoder</strong>也要换成<strong>BCryptPasswordEncoder</strong>。</p>

<pre><code>/**
 * 多个Http Security的配置
 */
@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)
public class MultiHttpSecurity {
    @Bean
    PasswordEncoder passwordEncoder() {
//        return NoOpPasswordEncoder.getInstance();
        return new BCryptPasswordEncoder();
    }

    //多个Http Security可以共享
    @Autowired
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
//                .withUser("xuxx").password("123").roles("admin")              .withUser("xuxx").password("$2a$10$gqUyIaadTdNQYVq7M1iRFO4Wl/sdvCPBvrBUwlX7u8qjbRFU7EoRK").roles("admin")
                .and()
//                .withUser("test").password("123").roles("user");             .withUser("test").password("$2a$10$tKe91qK4VcLRfS0rQ2THaeF/beXZKq283HaYJdogaOIVbiB7HaQ0u").roles("user");
    }

    @Configuration
    @Order(1)//存在多个相同的bean时就存在优先级的问题
    public static class AdminSecurity extends WebSecurityConfigurerAdapter {
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            //只会拦截符合/admin/**的所有请求
            http.antMatcher("/admin/**").authorizeRequests().anyRequest().hasRole("admin");
        }
    }

    @Configuration
    //@Order//不配置order时是优先级最低的,2的31次方-1
    public static class OtherSecurity extends WebSecurityConfigurerAdapter {
        @Override
        protected void configure(HttpSecurity http) throws Exception {
            http.authorizeRequests().anyRequest().authenticated()
                    .and()
                    .formLogin()
                    .loginProcessingUrl("/doLogin")
                    .permitAll()
                    .and()
                    .csrf()
                    .disable();
        }
    }
}</code></pre>
<p>测试：此时密码还是使用<code>123</code>依旧可以登录，但是如果此时要存储的密码的话，那么要存储的密码已经加密了。</p>
<p><figure class="pswp-item" style="flex: 165.70048309178745" data-width="1372" data-height="414"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/0b1ed5cb1dace2f1282680faa7bfaaf1.png" alt="" /></figure></p>
<h3>6.方法安全</h3>
<p>默认情况下, Spring Security 并不启用方法级的安全管控. 启用方法级的管控后, 可以针对不同的方法通过注解设置不同的访问条件.</p>
<p>启用方法级的管控代码是, 在一个Security配置类, 加上@EnableGlobalMethodSecurity() 注解, 通过@EnableGlobalMethodSecurity的参数开启相应的方法级的管控.</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * 多个Http Security的配置</span>
<span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="p">(</span><span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiHttpSecurity</span> <span class="p">{}</span>
</pre></div>
<p>Spring Security 支持三种方法级注解, 分别是 JSR-250 注解/@Secured 注解/prePostEnabled注解. 这些注解不仅可以直接加 <strong>controller 方法</strong>上, 也可以注解 <strong>Service 或 DAO 类中的方法</strong>.</p>
<h4>JSR-250 注解</h4>
<p>通过 @EnableGlobalMethodSecurity(jsr250Enabled = true), 开启 JSR-250 注解.</p>
<ul>
<li>@DenyAll 注解：拒绝所有的访问</li>
<li>@PermitAll 注解：运行所有访问</li>
<li>@RolesAllowed({"USER","ADMIN"})：该方法只允许有 ROLE_USER 或 ROLE_ADMIN 角色的用户访问.</li>
</ul>
<h4>@Secured 注解</h4>
<p>通过 @EnableGlobalMethodSecurity(securedEnabled = true), 开启 @Secured 注解.
只有满足角色的用户才能访问被注解的方法, 否则将会抛出 AccessDenied (禁止访问)异常.
例:</p>
<div class="highlight"><pre><span></span><span class="nd">@Secured</span><span class="p">(</span><span class="s">&quot;ROLE_TELLER&quot;</span><span class="p">,</span><span class="s">&quot;ROLE_ADMIN&quot;</span><span class="p">)</span><span class="c1">//该方法只允许 ROLE_TELLER 或 ROLE_ADMIN 角色的用户访问.</span>
<span class="nd">@Secured</span><span class="p">(</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span><span class="p">)</span><span class="c1">//该方法允许匿名用户访问.</span>
</pre></div>
<h4>@PreAuthorize 类型的注解(支持 Spring 表达式)</h4>
<p>@EnableGlobalMethodSecurity(prePostEnabled = true), 开启 prePostEnabled 相关的注解.
<strong>JSR-250 和 @Secured 注解功能较弱, 不支持 Spring EL 表达式. </strong></p>
<p><strong>推荐使用 @PreAuthorize 类型的注解.</strong>
 具体有4个注解.</p>
<ul>
<li>@PreAuthorize 注解：在方法调用之前, 基于表达式结果来限制方法的使用.</li>
<li>@PostAuthorize 注解： 允许方法调用, 但是如果表达式结果为 false, 将抛出一个安全性异常.</li>
<li>@PostFilter 注解：允许方法调用, 但必要按照表达式来过滤方法的结果.</li>
<li>@PreFilter 注解,：允许方法调用, 但必须在进入方法之前过来输入值.</li>
</ul>
<p>例:</p>
<div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">)</span> <span class="c1">//必须具有ROLE_ADMIN 角色</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBook</span><span class="p">(</span><span class="n">Book</span> <span class="n">book</span><span class="p">);</span>

<span class="c1">//必须同时具备 ROLE_ADMIN 和 ROLE_DBA 角色</span>
<span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;) AND hasRole(&#39;DBA&#39;)&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBook</span><span class="p">(</span><span class="n">Book</span> <span class="n">book</span><span class="p">);</span>

<span class="nd">@PreAuthorize</span> <span class="p">(</span><span class="s">&quot;#book.owner == authentication.name&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteBook</span><span class="p">(</span><span class="n">Book</span> <span class="n">book</span><span class="p">);</span>

<span class="nd">@PostAuthorize</span> <span class="p">(</span><span class="s">&quot;returnObject.owner == authentication.name&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Book</span> <span class="nf">getBook</span><span class="p">();</span>
</pre></div>
<h4>@PreAuthorize 表达式</h4>
<ol>
<li><p>returnObject 保留名
对于 @PostAuthorize 和 @PostFilter 注解, 可以在表达式中使用 returnObject 保留名, returnObject 代表着被注解方法的返回值, 我们可以使用 returnObject 保留名对注解方法的结果进行验证.</p>
<div class="highlight"><pre><span></span><span class="nd">@PostAuthorize</span> <span class="p">(</span><span class="s">&quot;returnObject.owner == authentication.name&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Book</span> <span class="nf">getBook</span><span class="p">();</span>
</pre></div>
</li>
<li><p>表达式中的 <strong>#</strong> 号
在表达式中, 可以使用 <strong>#argument123</strong> 的形式来代表注解方法中的参数 argument123.</p>
<div class="highlight"><pre><span></span><span class="nd">@PreAuthorize</span> <span class="p">(</span><span class="s">&quot;#book.owner == authentication.name&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteBook</span><span class="p">(</span><span class="n">Book</span> <span class="n">book</span><span class="p">);</span>

<span class="cm">/*还有一种 #argument123 的写法, 即使用 Spring Security @P注解来为方法参数起别名, 然后在 @PreAuthorize 等注解表达式中使用该别名. 不推荐这种写法, 代码可读性较差.*/</span>

<span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;#c.name == authentication.name&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="p">(</span><span class="nd">@P</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">)</span> <span class="n">Contact</span> <span class="n">contact</span><span class="p">);</span>
</pre></div>
</li>
<li><p>内置表达式有:</p>
<p>| 表达式                                                       | 备注                                                         |
 | ------------------------------------------------------------ | :----------------------------------------------------------- |
 | hasRole([role])                                              | 如果有当前角色, 则返回 true(会自动加上 ROLE<em> 前缀)           |
 | hasAnyRole([role1, role2])                                   | 如果有任一角色即可通过校验, 返回true,(会自动加上 ROLE</em> 前缀) |
 | hasAuthority([authority])                                    | 如果有指定权限, 则返回 true                                  |
 | hasAnyAuthority([authority1, authority2])                    | 如果有任一指定权限, 则返回true                               |
 | principal                                                    | 获取当前用户的 principal 主体对象                            |
 | authentication                                               | 获取当前用户的 authentication 对象,                          |
 | permitAll                                                    | 总是返回 true, 表示全部允许                                  |
 | denyAll                                                      | 总是返回 false, 代表全部拒绝                                 |
 | isAnonymous()                                                | 如果是匿名访问, 返回true                                     |
 | isRememberMe()                                               | 如果是remember-me 自动认证, 则返回 true                      |
 | isAuthenticated()                                            | 如果不是匿名访问, 则返回true                                 |
 | isFullAuthenticated()                                        | 如果不是匿名访问或remember-me认证登陆, 则返回true            |
 | hasPermission(Object target, Object permission)              |                                                              |
 | hasPermission(Object target, String targetType, Object permission) |                                                              |</p>
</li>
</ol>
<p>完整演示：</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * 多个Http Security的配置</span>
<span class="cm"> * 此时@EnableGlobalMethodSecurity开启了2种方法安全的注解，@Secured注解、@PreAuthorize 类型的注解</span>
<span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="p">(</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiHttpSecurity</span> <span class="p">{</span>
    <span class="p">...</span><span class="c1">//内容同上</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodService</span> <span class="p">{</span>

    <span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAnyRole(&#39;admin&#39;,&#39;user&#39;)&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;admin&#39;)&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">admin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello Admin&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Secured</span><span class="p">(</span><span class="s">&quot;ROLE_user&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">user</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello User&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MethodService</span> <span class="n">methodService</span><span class="p">;</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello_both&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello_both</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">methodService</span><span class="p">.</span><span class="na">hello</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello_user&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello_users</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">methodService</span><span class="p">.</span><span class="na">user</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello_admin&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello_admin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">methodService</span><span class="p">.</span><span class="na">admin</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>测试：</p>
<p>使用<code>test</code>登录时，可以调用<code>hello_both</code>、<code>hello_user</code>，调用<code>hello_admin</code>时403。</p>
<p><figure class="pswp-item" style="flex: 199.10979228486647" data-width="1342" data-height="337"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/9d889adb2aaf911e2d0fc4594271c454.png" alt="" /></figure></p>
<p>使用<code>xuxx</code>登录时，三个接口都可以访问。</p>
<h3>7.角色继承</h3>
<p>在Security配置类中添加以下代码</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * 角色继承</span>
<span class="cm"> * @return</span>
<span class="cm"> */</span>
<span class="nd">@Bean</span>
<span class="n">RoleHierarchy</span> <span class="nf">roleHierarchy</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RoleHierarchyImpl</span> <span class="n">roleHierarchy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RoleHierarchyImpl</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="s">&quot;ROLE_dba &gt; ROLE_admin \n ROLE_admin &gt; ROLE_user&quot;</span><span class="p">;</span>
    <span class="n">roleHierarchy</span><span class="p">.</span><span class="na">setHierarchy</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">roleHierarchy</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>SpringSecurity 在角色继承上有两种不同的写法，在 Spring Boot2.0.8（对应 Spring Security5.0.11）上面是一种写法，从 Spring Boot2.1.0（对应 Spring Security5.1.1）又是另外一种写法。</p>
<h4>1.以前的写法</h4>
<p>这里说的以前写法，就是指 SpringBoot2.0.8（含）之前的写法，在之前的写法中，角色继承只需要开发者提供一个 RoleHierarchy 接口的实例即可，例如下面这样：</p>
<div class="highlight"><pre><span></span><span class="nd">@BeanRoleHierarchy</span> <span class="n">roleHierarchy</span><span class="p">()</span> <span class="p">{</span>    
    <span class="n">RoleHierarchyImpl</span> <span class="n">roleHierarchy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RoleHierarchyImpl</span><span class="p">();</span>    
    <span class="n">String</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="s">&quot;ROLE_dba &gt; ROLE_admin ROLE_admin &gt; ROLE_user&quot;</span><span class="p">;</span>
    <span class="n">roleHierarchy</span><span class="p">.</span><span class="na">setHierarchy</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">);</span>    
    <span class="k">return</span> <span class="n">roleHierarchy</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>在这里提供了一个 RoleHierarchy 接口的实例，使用字符串来描述了角色之间的继承关系， <code>ROLE_dba</code> 具备 <code>ROLE_admin</code> 的所有权限，而 <code>ROLE_admin</code> 则具备 <code>ROLE_user</code> 的所有权限，继承与继承之间用一个空格隔开。提供了这个 Bean 之后，以后所有具备 <code>ROLE_user</code> 角色才能访问的资源， <code>ROLE_dba</code> 和 <code>ROLE_admin</code> 也都能访问，具备 <code>ROLE_amdin</code> 角色才能访问的资源， <code>ROLE_dba</code> 也能访问。</p>
<h4>2.现在的写法</h4>
<p>但是上面这种写法仅限于 Spring Boot2.0.8（含）之前的版本，在之后的版本中，这种写法则不被支持，新版的写法是下面这样：</p>

<pre><code>@BeanRoleHierarchy roleHierarchy() {    
    RoleHierarchyImpl roleHierarchy = new RoleHierarchyImpl();    
    String hierarchy = "ROLE_dba &gt; ROLE_admin \n ROLE_admin &gt; ROLE_user";
    roleHierarchy.setHierarchy(hierarchy);    
    return roleHierarchy;
}</code></pre>
<p>变化主要就是分隔符，将原来用空格隔开的地方，现在用换行符了。这里表达式的含义依然和上面一样，不再赘述。</p>
<p>上面两种不同写法都是配置角色的继承关系，配置完成后，接下来指定角色和资源的对应关系即可，如下：</p>

<pre><code>@Overrideprotected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
    .antMatchers("/admin/**").hasRole("admin")
    .antMatchers("/db/**").hasRole("dba")
    .antMatchers("/user/**").hasRole("user")
    .and().formLogin()
    .loginProcessingUrl("/doLogin")
    .permitAll()
    .and().csrf().disable();
}</code></pre>
<p>这个表示 <code>/db/**</code> 格式的路径需要具备 dba 角色才能访问， <code>/admin/**</code> 格式的路径则需要具备 admin 角色才能访问， <code>/user/**</code> 格式的路径，则需要具备 user 角色才能访问，此时提供相关接口，会发现dba 除了访问 <code>/db/**</code> ，也能访问 <code>/admin/**</code> 和 <code>/user/**</code> ，admin 角色除了访问 <code>/admin/**</code> ，也能访问 <code>/user/**</code> ，user 角色则只能访问 <code>/user/**</code> 。</p>
<h3>8.基于数据库的认证</h3>
<p>之前的用户和密码都是在代码或者配置文件中写死的，一般不满足开发的需要。</p>
<p>没啥说的，上代码！！</p>
<p>首先准备好数据库</p>
<div class="highlight"><pre><span></span><span class="o">--</span><span class="err">取消外键约束</span><span class="p">:</span>
<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">`role`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`role`</span> <span class="p">(</span>
  <span class="ss">`id`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="ss">`name`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="ss">`nameZh`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;dba&#39;</span><span class="p">,</span> <span class="s1">&#39;数据库管理员&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;系统管理员&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;用户&#39;</span><span class="p">);</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for user</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">`user`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`user`</span> <span class="p">(</span>
  <span class="ss">`id`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="ss">`username`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="ss">`password`</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="ss">`enabled`</span> <span class="kt">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="ss">`locked`</span> <span class="kt">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of user</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;xuxx&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for user_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">`user_role`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`user_role`</span> <span class="p">(</span>
  <span class="ss">`id`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="no">NULL</span> <span class="kp">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="ss">`uid`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="ss">`rid`</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="no">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="ss">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="kp">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">5</span> <span class="k">DEFAULT</span> <span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of user_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user_role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user_role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user_role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`user_role`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">);</span>
<span class="kt">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</pre></div>
<p>依赖</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.1.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.27<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<p>配置文件application.yml</p>
<div class="highlight"><pre><span></span><span class="nt">spring</span><span class="p">:</span>
  <span class="nt">datasource</span><span class="p">:</span>
    <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.zaxxer.hikari.HikariDataSource</span>
    <span class="nt">url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:mysql://127.0.0.1:3306/security?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai</span>
    <span class="nt">driver-class-name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.mysql.jdbc.Driver</span>
<span class="nt">mybatis</span><span class="p">:</span>
  <span class="c1">#mapper.xml路径</span>
  <span class="nt">mapper-locations</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">classpath:mapper/*.xml</span>
  <span class="c1">#别名包扫描</span>
  <span class="nt">type-aliases-package</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.xuxx.security_demo.bean</span>

<span class="nt">logging</span><span class="p">:</span>
  <span class="nt">level</span><span class="p">:</span>
    <span class="c1">#打印mapper包的SQL语句</span>
    <span class="nt">com.xuxx.security_demo.mapper</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">debug</span>
</pre></div>
<p>bean</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 继承UserDetails是为了向Spring Security提供核心用户信息</span>
<span class="cm"> * 同时，UserDetails也是一个规范</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">UserDetails</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">locked</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roleList</span><span class="p">;</span>

    <span class="cm">/***</span>
<span class="cm">     * 判断帐户是否未过期</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//我的数据库没写这个字段</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/***</span>
<span class="cm">     * 判断帐户是否未锁定</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 判断凭证是否未过期</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 判断是否已启用</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 获取已授予用户的权限(角色)，不能返回nulL。</span>
<span class="cm">     * SimpleGrantedAuthority：GrantedAuthority的简单实现。以字符串形式存储已授予的权限(角色)，要以‘ROLE_’开头。</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Role</span> <span class="n">role</span> <span class="p">:</span> <span class="n">roleList</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">authorities</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="s">&quot;ROLE_&quot;</span> <span class="o">+</span> <span class="n">role</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">authorities</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="nf">getRoleList</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">roleList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRoleList</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roleList</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">roleList</span> <span class="o">=</span> <span class="n">roleList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnabled</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLocked</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">locked</span> <span class="o">=</span> <span class="n">locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;User{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">&quot;, username=&#39;&quot;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, enabled=&quot;</span> <span class="o">+</span> <span class="n">enabled</span> <span class="o">+</span>
                <span class="s">&quot;, locked=&quot;</span> <span class="o">+</span> <span class="n">locked</span> <span class="o">+</span>
                <span class="s">&quot;, roleList=&quot;</span> <span class="o">+</span> <span class="n">roleList</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Role</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nameZh</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">User</span> <span class="n">user</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUser</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNameZh</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">nameZh</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNameZh</span><span class="p">(</span><span class="n">String</span> <span class="n">nameZh</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">nameZh</span> <span class="o">=</span> <span class="n">nameZh</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Role{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">&quot;, name=&#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, nameZh=&#39;&quot;</span> <span class="o">+</span> <span class="n">nameZh</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, user=&quot;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Mapper</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.mapper</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_demo.bean.Role</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_demo.bean.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 根据username查询User</span>
<span class="cm">     * @param username 用户名</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select * from user where username = #{username}&quot;</span><span class="p">)</span>
    <span class="n">User</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据userID查询User的角色</span>
<span class="cm">     * @param id 用户ID</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select * from role r where r.id in (select rid from user_role where uid = #{id})&quot;</span><span class="p">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="nf">getUserRolesById</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Service</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_demo.bean.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_demo.mapper.UserMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 不用自己判断登录成功与否，只需要去数据库查询。</span>
<span class="cm">     * @param username</span>
<span class="cm">     * @return</span>
<span class="cm">     * @throws UsernameNotFoundException</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userMapper</span><span class="p">.</span><span class="na">loadUserByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//UsernameNotFoundException会自动转换为BadCredentialsException的</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;用户不存在！&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">user</span><span class="p">.</span><span class="na">setRoleList</span><span class="p">(</span><span class="n">userMapper</span><span class="p">.</span><span class="na">getUserRolesById</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Controller</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.controller</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="p">{</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;hello security&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;dba/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">dba</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;hello dba&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;admin/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">admin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;hello admin&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;user/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">user</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;hello user&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>配置类</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_demo.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_demo.service.UserService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.hierarchicalroles.RoleHierarchy</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="p">;</span>

    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 角色继承</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="n">RoleHierarchy</span> <span class="nf">roleHierarchy</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">RoleHierarchyImpl</span> <span class="n">roleHierarchy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RoleHierarchyImpl</span><span class="p">();</span>
        <span class="n">String</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="s">&quot;ROLE_dba &gt; ROLE_admin \n ROLE_admin &gt; ROLE_user&quot;</span><span class="p">;</span>
        <span class="n">roleHierarchy</span><span class="p">.</span><span class="na">setHierarchy</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">roleHierarchy</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">userDetailsService</span><span class="p">(</span><span class="n">userService</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/dba/**&quot;</span><span class="p">).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;dba&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/admin/**&quot;</span><span class="p">).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/user/**&quot;</span><span class="p">).</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">()</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">formLogin</span><span class="p">()</span>
                <span class="p">.</span><span class="na">loginProcessingUrl</span><span class="p">(</span><span class="s">&quot;/doLogin&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="na">permitAll</span><span class="p">()</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">csrf</span><span class="p">()</span>
                <span class="p">.</span><span class="na">disable</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>大功告成。</p>
<h2>3.动态权限配置</h2>
<p>目的是实现Spring Security从DB中加载URL的相关权限，且当DB中配置发生更改时，可以让运行中的项目无需重启，动态更改访问权限。</p>
<p>数据库(在之前的基础上添加了两张表，menu和menu_role)</p>
<div class="highlight"><pre><span></span><span class="c1">--取消外键约束:</span>
<span class="k">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="k">role</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="k">role</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">nameZh</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;dba&#39;</span><span class="p">,</span> <span class="s1">&#39;数据库管理员&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;系统管理员&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;用户&#39;</span><span class="p">);</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for user</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="k">user</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">enabled</span><span class="o">`</span> <span class="n">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">locked</span><span class="o">`</span> <span class="n">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of user</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;xuxx&#39;</span><span class="p">,</span> <span class="s1">&#39;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">);</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for user_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">uid</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">rid</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">5</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of user_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">user_role</span><span class="o">`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">);</span>
<span class="k">SET</span> <span class="n">FOREIGN_KEY_CHECKS</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for menu</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">menu</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">menu</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">pattern</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of menu</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">pattern</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;/db/**&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">pattern</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;/admin/**&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">pattern</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;/user/**&#39;</span><span class="p">);</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Table structure for menu_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">menu_role</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">menu_role</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">mid</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">rid</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">4</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of menu_role</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu_role</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">mid</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">rid</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu_role</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">mid</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">rid</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">`</span><span class="n">menu_role</span><span class="o">`</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">mid</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">rid</span><span class="o">`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
<p>依赖</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>2.1.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.27<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<p>application.yml</p>
<div class="highlight"><pre><span></span><span class="nt">spring</span><span class="p">:</span>
  <span class="nt">datasource</span><span class="p">:</span>
    <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.zaxxer.hikari.HikariDataSource</span>
    <span class="nt">url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:mysql://127.0.0.1:3306/security?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai</span>
    <span class="nt">driver-class-name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.mysql.jdbc.Driver</span>
<span class="nt">mybatis</span><span class="p">:</span>
  <span class="c1">#mapper.xml路径</span>
  <span class="c1">#mapper-locations: classpath:mapper/*.xml</span>
  <span class="c1">#别名包扫描</span>
  <span class="nt">type-aliases-package</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">com.xuxx.security_db_dynamic.bean</span>

<span class="nt">logging</span><span class="p">:</span>
  <span class="nt">level</span><span class="p">:</span>
    <span class="c1">#打印mapper包的SQL语句</span>
    <span class="nt">com.xuxx.security_db_dynamic.mapper</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">debug</span>
</pre></div>
<p>bean</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 继承UserDetails是为了向Spring Security提供核心用户信息</span>
<span class="cm"> * 同时，UserDetails也是一个规范</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">UserDetails</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">locked</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roleList</span><span class="p">;</span>

    <span class="cm">/***</span>
<span class="cm">     * 判断帐户是否未过期</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//此时数据库没定义这个字段</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/***</span>
<span class="cm">     * 判断帐户是否未锁定</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 判断凭证是否未过期</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 判断是否已启用</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 获取已授予用户的权限(角色)，不能返回nulL。</span>
<span class="cm">     * SimpleGrantedAuthority：GrantedAuthority的简单实现。以字符串形式存储已授予的权限(角色)，要以‘ROLE_’开头。</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Role</span> <span class="n">role</span> <span class="p">:</span> <span class="n">roleList</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">authorities</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="s">&quot;ROLE_&quot;</span> <span class="o">+</span> <span class="n">role</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">authorities</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="nf">getRoleList</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">roleList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRoleList</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roleList</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">roleList</span> <span class="o">=</span> <span class="n">roleList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnabled</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLocked</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">locked</span> <span class="o">=</span> <span class="n">locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;User{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">&quot;, username=&#39;&quot;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, password=&#39;&quot;</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="s">&quot;, enabled=&quot;</span> <span class="o">+</span> <span class="n">enabled</span> <span class="o">+</span>
                <span class="s">&quot;, locked=&quot;</span> <span class="o">+</span> <span class="n">locked</span> <span class="o">+</span>
                <span class="s">&quot;, roleList=&quot;</span> <span class="o">+</span> <span class="n">roleList</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Role</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nameZh</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.bean</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Menu</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">pattern</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roles</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Mapper</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.mapper</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Role</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="p">{</span>

    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select * from user where username =#{username} &quot;</span><span class="p">)</span>
    <span class="n">User</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">);</span>

    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select * from role r where r.id in (select rid from user_role where uid = #{id}) &quot;</span><span class="p">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="nf">getRolesById</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.mapper</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Menu</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Role</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.mapping.FetchType</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MenuMapper</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * 查询所有的menu</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select m.*,r.id as rid,r.name as rname, r.nameZh as rnameZh from menu m left join menu_role mr on m.id = mr.id left join role r on mr.rid = r.id &quot;</span><span class="p">)</span>
    <span class="nd">@Results</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;menuResultMap&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nd">@Result</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="p">),</span>
            <span class="nd">@Result</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s">&quot;pattern&quot;</span><span class="p">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">&quot;pattern&quot;</span><span class="p">),</span>
            <span class="nd">@Result</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s">&quot;rid&quot;</span><span class="p">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">&quot;roles&quot;</span><span class="p">,</span>
                    <span class="n">many</span> <span class="o">=</span> <span class="nd">@Many</span><span class="p">(</span><span class="n">select</span> <span class="o">=</span> <span class="s">&quot;com.xuxx.security_db_dynamic.mapper.MenuMapper.findRolesByMenuId&quot;</span><span class="p">,</span> <span class="n">fetchType</span> <span class="o">=</span> <span class="n">FetchType</span><span class="p">.</span><span class="na">EAGER</span><span class="p">))</span>
    <span class="p">})</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Menu</span><span class="o">&gt;</span> <span class="nf">getAllMenus</span><span class="p">();</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据menuID查询roles</span>
<span class="cm">     * @param id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Select</span><span class="p">(</span><span class="s">&quot;select * from role where id = #{id}&quot;</span><span class="p">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="nf">findRolesByMenuId</span><span class="p">(</span><span class="n">Integer</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>Service</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.mapper.UserMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserMapper</span> <span class="n">userMapper</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userMapper</span><span class="p">.</span><span class="na">loadUserByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;用户不存在&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">user</span><span class="p">.</span><span class="na">setRoleList</span><span class="p">(</span><span class="n">userMapper</span><span class="p">.</span><span class="na">getRolesById</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Menu</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.mapper.MenuMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MenuService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">MenuMapper</span> <span class="n">menuMapper</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Menu</span><span class="o">&gt;</span> <span class="nf">getAllMenus</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">menuMapper</span><span class="p">.</span><span class="na">getAllMenus</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Controller</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.controller</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="p">{</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/dba/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">db</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello dba&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/admin/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">admin</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello admin&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/user/hello&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">user</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Hello user&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>配置类</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Menu</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.bean.Role</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.service.MenuService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.ConfigAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.SecurityConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.FilterInvocation</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.access.intercept.FilterInvocationSecurityMetadataSource</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.AntPathMatcher</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 根据传来的请求地址，分析出该请求所需要的权限(角色)</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyFilter</span> <span class="kd">implements</span> <span class="n">FilterInvocationSecurityMetadataSource</span> <span class="p">{</span>

    <span class="c1">//路径匹配器</span>
    <span class="n">AntPathMatcher</span> <span class="n">pathMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AntPathMatcher</span><span class="p">();</span>

    <span class="nd">@Autowired</span>
    <span class="n">MenuService</span> <span class="n">menuService</span><span class="p">;</span>

    <span class="c1">//根据请求地址分析所需要的权限(角色)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="p">(</span><span class="n">Object</span> <span class="n">object</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="p">{</span>
        <span class="c1">//拿到请求的URl</span>
        <span class="n">String</span> <span class="n">requestUrl</span> <span class="o">=</span> <span class="p">((</span><span class="n">FilterInvocation</span><span class="p">)</span> <span class="n">object</span><span class="p">).</span><span class="na">getRequestUrl</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Menu</span><span class="o">&gt;</span> <span class="n">allMenus</span> <span class="o">=</span> <span class="n">menuService</span><span class="p">.</span><span class="na">getAllMenus</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Menu</span> <span class="n">menu</span> <span class="p">:</span> <span class="n">allMenus</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//如果请求的URL和定义的规则匹配上了</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pathMatcher</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">menu</span><span class="p">.</span><span class="na">getPattern</span><span class="p">(),</span> <span class="n">requestUrl</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="na">getRoles</span><span class="p">();</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">rolesStr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">roles</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
                <span class="c1">//将请求的URL所需要的所有role转成字符串数组</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">roles</span><span class="p">.</span><span class="na">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">rolesStr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="s">&quot;ROLE_&quot;</span> <span class="o">+</span> <span class="n">roles</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="na">getName</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">SecurityConfig</span><span class="p">.</span><span class="na">createList</span><span class="p">(</span><span class="n">rolesStr</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//如果路径匹配不上，返回ROLE_login(相当于自定义的一个标记)，则登录后可以访问（自定义的）</span>
        <span class="k">return</span> <span class="n">SecurityConfig</span><span class="p">.</span><span class="na">createList</span><span class="p">(</span><span class="s">&quot;ROLE_LOGIN&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAllConfigAttributes</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span><span class="c1">//是否支持</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.access.AccessDecisionManager</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.AccessDeniedException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.access.ConfigAttribute</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AnonymousAuthenticationToken</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.InsufficientAuthenticationException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 判断当前用户是否具备其访问路径的权限(角色)</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyAccessDecisionManager</span> <span class="kd">implements</span> <span class="n">AccessDecisionManager</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * @param authentication   保存了当前登录用户信息(已经有哪些角色)</span>
<span class="cm">     * @param object           (FilterInvocation对象，是Myfilter类的getAttributes方法中的object参数)用来获取当前请求对象</span>
<span class="cm">     * @param configAttributes 是Myfilter类的getAttributes方法的返回值，请求需要哪些角色</span>
<span class="cm">     * @throws AccessDeniedException</span>
<span class="cm">     * @throws InsufficientAuthenticationException</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">decide</span><span class="p">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="p">,</span> <span class="n">Object</span> <span class="n">object</span><span class="p">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">configAttributes</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">AccessDeniedException</span><span class="p">,</span> <span class="n">InsufficientAuthenticationException</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ConfigAttribute</span> <span class="n">attribute</span> <span class="p">:</span> <span class="n">configAttributes</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&quot;ROLE_LOGIN&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">attribute</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">()))</span> <span class="p">{</span>
                <span class="c1">//AnonymousAuthenticationToken匿名身份验证令牌(未登录)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">authentication</span> <span class="k">instanceof</span> <span class="n">AnonymousAuthenticationToken</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AccessDeniedException</span><span class="p">(</span><span class="s">&quot;非法请求！&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">//已登录</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">//如果具备所需的角色</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">authentication</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">GrantedAuthority</span> <span class="n">authority</span> <span class="p">:</span> <span class="n">authorities</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//如果已具备角色存在一个所需角色就通过(也可以配置其他验证方式，例如：所需多个角色时，必须与已具备角色一一匹配)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">authority</span><span class="p">.</span><span class="na">getAuthority</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">attribute</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="c1">//return就会验证通过</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">//此时登录的root,访问的/admin/hello</span>
            <span class="c1">//authorities:[ROLE_dba, ROLE_admin]</span>
            <span class="c1">//System.out.println(&quot;authorities:&quot; + authorities.toString());</span>
            <span class="c1">//object:FilterInvocation: URL: /admin/hello</span>
            <span class="c1">//System.out.println(&quot;object:&quot; + object.toString());</span>
            <span class="c1">//configAttributes:[ROLE_admin]</span>
            <span class="c1">//System.out.println(&quot;configAttributes:&quot; + configAttributes.toString());</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">AccessDeniedException</span><span class="p">(</span><span class="s">&quot;非法请求！&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span><span class="c1">//是否支持</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="p">(</span><span class="n">ConfigAttribute</span> <span class="n">attribute</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span><span class="c1">//是否支持</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.xuxx.security_db_dynamic.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.xuxx.security_db_dynamic.service.UserService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.ObjectPostProcessor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.web.access.intercept.FilterSecurityInterceptor</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="p">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">MyFilter</span> <span class="n">myFilter</span><span class="p">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">MyAccessDecisionManager</span> <span class="n">myAccessDecisionManager</span><span class="p">;</span>

    <span class="nd">@Bean</span>
    <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">BCryptPasswordEncoder</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">auth</span><span class="p">.</span><span class="na">userDetailsService</span><span class="p">(</span><span class="n">userService</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
        <span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span>
                <span class="p">.</span><span class="na">withObjectPostProcessor</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectPostProcessor</span><span class="o">&lt;</span><span class="n">FilterSecurityInterceptor</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">O</span> <span class="kd">extends</span> <span class="n">FilterSecurityInterceptor</span><span class="o">&gt;</span> <span class="n">O</span> <span class="nf">postProcess</span><span class="p">(</span><span class="n">O</span> <span class="n">object</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">object</span><span class="p">.</span><span class="na">setAccessDecisionManager</span><span class="p">(</span><span class="n">myAccessDecisionManager</span><span class="p">);</span>
                        <span class="n">object</span><span class="p">.</span><span class="na">setSecurityMetadataSource</span><span class="p">(</span><span class="n">myFilter</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">object</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">formLogin</span><span class="p">()</span>
                <span class="p">.</span><span class="na">permitAll</span><span class="p">()</span>
                <span class="p">.</span><span class="na">and</span><span class="p">()</span>
                <span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>大功告成！！累死了...</p>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Xuxx_Blogs/tag/Java/">#Java</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Xuxx_Blogs/tag/Spring/">#Spring</a>
    </span>
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Xuxx_Blogs/tag/Security/">#Security</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <h3>没有了</h3>
        <p class="yue">这是最新的文章</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/Xuxx_Blogs/archives/bj20/">Spring Boot整合WebSocket</a>
        <p class="yue">笔记</p>
    </div>

</section>


    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">Xuxx的个人博客。</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2020 Xuxx</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/xuxx3309" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/QQ1820582487" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2019-12-26T02:30+08:00"
                    </script>
                    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/galileo-d8a0a06eff.js"></script>
                </footer>
            </div>
        </div>
    </div>
        
        
        <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <button class="pswp__button pswp__button--share" title="Share"></button>
                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                          <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                          </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div> 
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
    
    <!--katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
    </body>
</html>