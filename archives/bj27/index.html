<!DOCTYPE HTML>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Xuxx,Galileo,blog" />
    <meta name="generator" content="Maverick 1.0" />
    <meta name="template" content="Galileo" />
    <link rel="alternate" type="application/rss+xml" title="Xuxx - 个人博客 &raquo; RSS 2.0" href="/Xuxx_Blogs/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="Xuxx - 个人博客 &raquo; ATOM 1.0" href="/Xuxx_Blogs/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/galileo-ec40839efa.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/ExSearch-182e5a8868.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/287869a541054c65a52cf04d8a7e302f.json"
        }
    </script>
    
<title>MySQL优化相关 - Xuxx - 个人博客</title>
<meta name="author" content="Xuxx" />
<meta name="description" content="笔记" />
<meta property="og:title" content="MySQL优化相关 - Xuxx - 个人博客" />
<meta property="og:description" content="笔记" />
<meta property="og:site_name" content="Xuxx - 个人博客" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/Xuxx_Blogs/archives/bj27/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2020-08-27T16:50:00-00.00" />
<meta name="twitter:title" content="MySQL优化相关 - Xuxx - 个人博客" />
<meta name="twitter:description" content="笔记" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />

    </head>
    
    <body>
        
        <div class="container">
            <header id="ga-header">
                <div first>
                    <aside id="ga-logo">
                        <a href="/Xuxx_Blogs/" target="_self">
                            <img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/logo.png" alt="Xuxx - 个人博客">
                        </a>
                    </aside>
                    <aside id="ga-brand">
                        <h1 class="brand"><a class="no-style" href="/Xuxx_Blogs/">Xuxx - 个人博客</a></h1>
                        <p>坚持有效行动，改变自然发生。</p>
                    </aside>
                </div>
                <div second id="ga-nav">
                    <nav class="navs">
                        <ul><li><a class="ga-highlight" href="/Xuxx_Blogs/" target="_self">首页</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Xuxx_Blogs/archives/" target="_self">归档</a></li><span class="separator">·</span><li><a class="ga-highlight" href="/Xuxx_Blogs/about/" target="_self">关于</a></li><span class="separator">·</span><li><a href="#" target="_self" class="search-form-input ga-highlight">搜索</a></li></ul>
                    </nav>
                    <nav class="social-links">
                        <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/xuxx3309" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/QQ1820582487" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                    </nav>
                </div>
            </header>
            <div class="wrapper">
                
<main>    
    <section class="ga-section ga-content">
        <article class="yue">
            <h1 class="ga-post_title">MySQL优化相关</h1>
            <span class="ga-post_meta ga-mono">
                <span>Xuxx</span>
                <time>
                    2020-08-27
                </time>
                
                in <a no-style class="category" href="/Xuxx_Blogs/category/笔记/">
                    笔记
                </a>
                
                
            </span>
            <div class="ga-content_body">
                <h1>MySQL分层逻辑架构</h1>
<h3>一. MySQL逻辑分层</h3>
<p>首先可以把服务端想象成一个大的容器，里面有四层结构，当一个请求过来后，将会执行这四层，执行一遍后才会返回给想要的结果。</p>
<h4>1.连接层</h4>
<p>客户端发送一个Select是直接交给连接层来处理，而它的作用就是提供与客户端连接的服务.连接层只是与客户端建立起连接.完成一些类似连接处理,授权认证 及相关的安全方案. 在该层上引入了连接池的概念.</p>
<h4>2.服务层</h4>
<p>提供核心的服务功能,如sql接口,完成缓存的查询,</p>
<p>sql的分析和优化部分及内置函数的执行.</p>
<p>服务包括以下内容:</p>
<h5>2.1Mangement Service</h5>
<p>备份  安全  复制  集群</p>
<h5><strong>2.2-</strong>SQL interface</h5>
<p>存储过程    视图  触发器</p>
<h5>2.3-Parser解析</h5>
<p>查询事务    对象权限</p>
<h5>2.4-Optimizer优化器</h5>
<p>当编写Sql语句执行时，优化器会觉得我写的sql语句性能不够好，这个时候，优化器会自己写一个等价于跟我写的执行后结果一致的sql语句进行代替.</p>
<h5>2.5-Cache Buffers</h5>
<p>缓存</p>
<p>服务器会查询内部的缓存,如果缓存空间足够大,这样可以解决大量读操作的环境中,能够很好的提升系统性能</p>
<h4>3.引擎层</h4>
<p>存储引擎是真正负责MYSQL中数据的存储和提取,服务器通过API与存储引擎进行通信, 不同的存储引擎提供的功能不同,可以根据自己的实际需求来进行选取。</p>
<p>常见的有：lnnoDB、MylSAM、Memory</p>
<ul>
<li><p>lnnoDB：它在设计的时候，它是事务优先。</p>
<p>原理：因为它是行锁，每一条数据都要锁，锁的太多，性能就降低了，虽然性能降低了，但是适合高并发了，就不容易出错了。</p>
</li>
<li><p>MylSAM：性能优先</p>
<p>原理：因为它是表锁，对于表里面的十条数据来说是不受影响的，对十条锁一次就完了，所以性能快。</p>
</li>
<li><p>Memroy：memory存储引擎是MySQL中的一类特殊的存储引擎。</p>
<p>其使用存储在内存中的内容来创建表，而且所有数据也放在内存中,因此，其基于内存中的特性，这类表的处理速度会非常快，但是，其数据易丢失，生命周期短。</p>
</li>
</ul>
<h4>4.存储层</h4>
<p>主要是将数据存储在运行的计算机文件系统之上,并完成与存储引擎的交互。</p>
<h3>二. 整体执行流程</h3>
<p>1.首先客户端发出一个Select操作</p>
<p>2.连接层接收后给服务层</p>
<p>3.服务层对你的查询进行一个优化，并把优化结果给引擎层</p>
<p>4.选择当前数据库的引擎，选完引擎后，引擎将最终的数据交给了存储层</p>
<p>5.存储层，用存储层来存储数据</p>
<h1>MySQL索引</h1>
<h3>什么是索引？</h3>
<p>首先，索引是一种数据结构。排好序的快速查找的数据结构。</p>
<p>在数据之外，数据库系统还维持着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构的基础上实现高级查找算法。这种数据结构，就是索引。</p>
<h3>索引的优势</h3>
<ol>
<li><p>提高检索效率，降低数据库的IO成本</p>
<p>类似图书馆里的图书管理，提高数据的检索效率，降低了io成本。例如：图书管理有100万条藏书，ok，兄弟此时进去找书，如果没有索引，从第一条到到100万条，祖坟冒青烟你牛恰巧第一条就是要找到图书，那么点子背的找到100万条全表扫描。那么这个时候如果频繁进行100万次的IO。不仅浪费时间，而且还消耗内存。如果像上面树的方式大大减少查找时间和IO的频繁。</p>
</li>
<li><p>通过索引列队数据进行排序，降低数据排序的成本，降低了CPU的消耗。</p>
</li>
</ol>
<h3>索引的劣势</h3>
<ol>
<li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表中的记录，所以索引列也是要占空间的。</li>
<li>虽然索引大大提高了查询速度，同时会降低更新表的速度。比如对表进行INSERT、UPDATE、DELETE。因为更新表时，MySQL不仅要保存树，还要保存一下索引文件每次更新添加了索引列的字段。都会调整因为每次更新带来的键值变化后的索引。</li>
</ol>
<p>索引只是提高效率的一个因素，如果你的MySQL有大数据量的表，就需要花时间来研究建立最优秀的索引，或者优化查询SQL语句。</p>
<h3>磁盘IO与预读</h3>
<p>考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，<strong>当一次IO时，不仅把当前磁盘地址的数据，而且把相邻的数据也都读取到内存缓冲区内</strong>，因为局部预读性原理告诉，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据称之为一页(page)。具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是读取一页内的数据时候，实际上才发生了一次IO，这个理论对于索引的数据结构设计非常有帮助。</p>
<h3>适合建索引和不适合建索引</h3>
<p>哪些情况适合建索引：</p>
<ol>
<li>主键自动建立唯一索引</li>
<li>频繁作为查询条件的字段应该创建索引</li>
<li>查询中与其他标关联的字段，外检关联建立索引</li>
<li>频繁更新的字段不适合创建索引（更新字段不仅要更新数据本身，而且还要更新索引树）</li>
<li>where条件里用不到的字段不创建索引</li>
<li>单键/组合索引的选择问题，who？（在高并发下倾向创建组合索引）</li>
<li>查询中排序的字段，排序的字段若通过索引去访问将大大提高排序速度（索引主要干两件事：检索、排序。）</li>
<li>查询中要统计或者分组的字段</li>
</ol>
<p>哪些情况不适合建索引：</p>
<ol>
<li>表记录太少（300万左右性能开始逐渐下降，虽然官方文档说撑得住5-8百万以上，但是根本也不能等到这个时候再去优化，性能肯定会受到影响）</li>
<li>经常增删改的表（为什么？提高了查询速度，同时却会降低了更新表的速度，入队表进行INSERT,UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存索引文件）。</li>
<li>数据重复切分布平均的表字段，因此应该只为最经常查询和最经常排序的数据建立索引。注意，如果某个数据列包括许多重复的内容，为它建立索引就没有太大的实际效果了。（假设一个表有10万行的记录，有一个字段A只有True和False两个值，且每个值的分布概率大约为50%，那么对这种表的A字段建立索引一般不会提高数据库的查询速度。再比如对银行卡建立索引，毕竟银行卡没有重复的。索引的选择性是指索引列中不同值的数据与表中的记录数的比，如果一个表中有2000条记录，表索引列就有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。一个索引的选择性越接近于1，那么这个索引的效率就越高。）</li>
</ol>
<h1>MySQL索引优化1-性能分析Explain</h1>
<h3>MySQL自带查询优化器(MySQL Query Optimizer)</h3>
<ol>
<li>MySQL中有专门负责优化SELECT语句的优化器模块，主要功能：通过计算机分析系统中收集到的统计信息，为客户端请求的Query提供他认为最优的执行计划（系统认为最优的数据检索方式，不见得是DBA认为是最优的，这部分最耗费时间）</li>
<li>当客户端向MySQL请求一条Query，命令解析器模块完成请求分类，区别处是SELECT并转发给MySQL Query Optimizer时，MySQL Query Optimizer 会先对整条Query进行优化，处理吊一些常量表达式的预算，直接换算成常量值，并对Query中的查询条件进行简化和转换，去掉一些无用或显而易见的条件、结构调整等。然后分析Query中的hint信息（如果有），看现实Hint信息是否可以完全确定该Query的执行计划。如果没有Hint或Hint信息不足以完全确定执行计划，则会读取索设计对象的统计信息，根据Query进行写相应的计算分析，然后在得出最后的执行计划。</li>
</ol>
<h3>MySQL常见瓶颈</h3>
<ol>
<li>CPU：CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据的时候</li>
<li>IO：磁盘I/O瓶颈发生在装入数据远大于内存容量的时候</li>
<li>服务器硬盘的性能瓶颈：top，free，iostat和vmstat来查看系统的性能状态</li>
</ol>
<p>如果SQL优化器没有更改，并且这些瓶颈也没有出现，那么调出MySQL分析报告来看看到底MySQL哪里惹了事。</p>
<h3>EXPLAIN</h3>
<blockquote><p><a href="https://dev.MySQL.com/doc/refman/8.0/en/execution-plan-information.html">官方文档</a></p>
</blockquote>
<ol>
<li>是什么？（查看执行计划）</li>
</ol>
<ul>
<li>使用Explain关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的，分析你的查询语句或是表结构的性能瓶颈。</li>
</ul>
<ol>
<li>能干吗？</li>
</ol>
<ul>
<li>表的读取顺序</li>
<li>数据读取操作的操作类型</li>
<li>哪些索引可以使用</li>
<li>哪些索引被实际使用</li>
<li>表之间的引用</li>
<li>每张表有多少行被优化器查询</li>
</ul>
<ol>
<li>怎么用？</li>
</ol>
<ul>
<li>Explain + SQL语句</li>
<li>执行计划包含的信息</li>
</ul>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_06.png" alt="" /></figure></p>
<p>各字段解释:</p>
<ul>
<li><p><strong>id</strong>：select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序。</p>
<ul>
<li>包含3种情况：<ul>
<li>id相同，执行顺序由上至下</li>
<li>id不同，值越大优先级越高越先被执行</li>
<li>id部分相同，如果id相同，可认为是同一组，执行顺序从上到下。在所有组中，id值越大执行优先级越高。</li>
</ul>
</li>
</ul>
<p>总结：id的值表示select子句或表的执行顺序，id相同，执行顺序从上到下，id不同，值越大的执行优先级越高。</p>
</li>
<li><p>select_type：SELECT的类型</p>
<p>常见：</p>
<ul>
<li>SIMPLE : 简单的SELECT查询, 查询中不包含子查询或者UNION</li>
<li>PRIMARY : 查询中包含任何复杂的子查询, 最外层查询被标记为PRIMARY</li>
<li>SUBQUERY : 在SELECT或WHERE列表中包含子查询</li>
<li>DERIVED : 在FROM列表中包含的子查询被标记为DERIVED(衍生), MySQL会递归执行这些子查询, 把结果放在临时表里</li>
<li>UNION : 若第二个SELECT出现在UNION之后, 则被标记为UNION; 若UNION包含在FROM子句的子查询中, 外层SELECT被标记为 : DERIVED</li>
<li>UNION RESULT : 从UNION表获取结果的SELECT</li>
</ul>
</li>
<li><p>table：显示这一行的数据是关于哪张表的</p>
</li>
<li><p><strong>type</strong>：访问类型, 显示查询使用了何种类型，</p>
<p>从最好到最差依次是：<strong>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</strong> （常见的）</p>
<p>一般来说, 要保证查询至少达到 range 级别, 最好能达到 ref 。</p>
<ul>
<li><p>system：表只有一行记录(等于系统表), 这是 const 类型的特例, 平时不会出现</p>
</li>
<li><p>const：表示通过索引一次就找到了, const 用于比较 primary key 或者 unique 索引。因为只匹配一行数据, 索引很快, 如将主键置于where列表中, MySQL就能将该查询转换为一个“常量”。</p>
</li>
<li><p>eq_ref：唯一性索引扫描, 对于每个索引键, 表中只有一条记录与之匹配。常见于主键或唯一索引扫描</p>
</li>
<li><p>ref：非唯一性索引扫描, 返回匹配某个单独值的所有行。本质上也是一种索引访问, 它返回所有匹配某个单独值的行, 可能会找到多个符合条件的行, 所以这个应该属于查找和扫描的混合体</p>
<p>eq_ref和ref：就好比一个班级里面，只有一个班主任和一群学生，t2返回的只有一个记录（就就好比班主任），而col1返回的是所有col1等于ac（所有名字是ac的学生）</p>
</li>
<li><p>range：只检索给定范围的行, 使用一个索引来选择行。key 列显示使用了哪个索引, 一般就是在 where 语句中出现了between, &lt; ,&gt; ,in 等的查询。这种范围索引扫描比全表扫描要好, 因为它只需要开始于索引的某一点, 而结束于另一点, 不用扫描全部索引。</p>
</li>
<li>index：Full Index Scan(全索引扫描), index与ALL的区别为index类型只遍历索引树。这通常比ALL快, 因为索引文件通常比数据文件小。(也就是说，虽然<strong>ALL和index都是读全表, 但index是从索引中读取的, 而ALL是从硬盘中读取的</strong>)。</li>
<li>ALL：Full Table Scan(全表扫描), 将遍历全表以找到匹配的行。</li>
</ul>
</li>
<li><p>possible_keys：可能用到的索引，一个或多个，<strong>但不一定被查询实际使用</strong>。</p>
</li>
<li><p><strong>key</strong>：</p>
<ul>
<li>实际使用的索引, 如果为NULL, 则没有使用索引。（要么没建索引，要么建了索引没用，即索引失效）</li>
<li>查询中若使用了覆盖索引, 则该索引仅出现在key列表中</li>
</ul>
</li>
<li><p>key_len：</p>
<ul>
<li>表示索引中使用的字节数, 可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下, 长度越短越好。（有句话说就是：不给马吃草，又要马儿跑）</li>
<li>key_len显示的值为索引字段的最大可能长度, <strong>并非实际使用长度</strong>, 即 key_len 是根据表定义计算而得, 不是通过表内检索获得的（同样的查询结果，key_len用的越少越好）</li>
</ul>
</li>
<li><p>ref：显示索引的哪一列被使用了, 如果可能的话, 最好是一个常数。哪些列或常量被用于查找索引列上的值。</p>
</li>
<li><p><strong>rows</strong>：根据表统计信息及索引选用情况, 大致估算出找到所需记录所需要读取的行数（表中有多少行被优化器查询）</p>
</li>
<li><p><strong>Extra</strong>：包含不适合在其他列中显示但十分重要的额外信息</p>
<ul>
<li><strong>Using filesort</strong> : 说明MySQL会对数据使用一个外部的索引排序, 而不是按照表内索引顺序进行读取。<strong>MySQL中无法利用索引完成的排序操作称为"文件内排序"</strong>。</li>
<li><strong>Using temporary</strong> : 同比前者性能更差，使用了临时表保存中间结果, MySQL在对查询结果排序时使用了临时表。常见于排序order by和分组查询group by。</li>
<li><strong>Using index</strong> : 表示相应的SELECT操作中使用了<strong>覆盖索引(Covering Index)</strong>, 避免了访问表的数据行, 效率还可以</li>
<li>Using where : 使用了where过滤</li>
<li>Using join buffer : 使用了连接缓存索引优化MIN/MAx操作或者对于MyIsam存储引擎优化COUNT(*)操作, 不必等到执行阶段再进行计算, 查询执行计划生成阶段即完成优化。</li>
<li>Impossible WHERE : where子句值总是false, 不能用来获取任何数据, 如name=‘张三’ and name=‘李四’(不可能一个人名字是张三，又是李四吧)</li>
<li>Select tables optimized away : 在没有group by子句的情况下, 基于distinct : 优化distinct操作, 在找到第一匹配的元组后即停止找同样值的动作</li>
</ul>
</li>
</ul>
<h3>补充</h3>
<p><strong>覆盖索引(Covering Index)，一说为索引覆盖</strong></p>
<p>理解方式一：就是select的数据列只用从索引中就能够获取，不比读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件，换句话说<strong>查询列要被所建的索引覆盖。</strong>（也就是说建的索引是col1,col2,col3的复合索引，刚好查询的也是这几列或者部分满足）</p>
<p>理解方式二：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的行，因此它不必读取整个行，毕竟索引叶子节点存储了他们所引用的数据，当能通过读取索引就可以得到想要的数据，那就不需要读取行了，一个索引包含了（或覆盖了）满足查询结果的数据就叫做覆盖索引。</p>
<p><strong>注意：</strong>如果使用覆盖索引，一定要注意select列表中只要所需的列，不可 select * ；因为如果将所有的字段一起做索引会导致索引文件过大，查询性能下降。</p>
<h1>MySQL索引优化2-优化法则</h1>
<ol>
<li><p>全值匹配我最爱(怎么建就怎么用)</p>
</li>
<li><p><strong>最佳左前缀法则</strong>：如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</p>
</li>
<li><p>不在索引列上做任何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描厨</p>
</li>
<li><p>存储引擎不能使用索引中范围条件右边的列</p>
</li>
<li><p>尽量使用覆盖索引(只访问索引的查询(索引列和查询列一致))，减少select *</p>
</li>
<li><p>MySQL在使用不等于(!=或者&lt;&gt;)的时候无法使用索引会导致全表扫描</p>
</li>
<li><p>is null ,is not null也无法使用索引</p>
</li>
<li><p>like以通配符开头('%abc...')MySQL索引失效会变成全表扫描的操作(like % 加右边)</p>
<p>问题:解决like '%字符串%'时索引不被使用的方法? —— 覆盖索引（索引的个数和顺序与查询的字段完全相同或者部分相同）</p>
</li>
<li><p>字符串不加单引号索引失效</p>
</li>
<li><p>少用or,用它来连接时会索引失效</p>
</li>
</ol>
<p><strong>口诀：</strong></p>
<p>​   全值匹配我最爱，最左前缀要遵守;
​   带头大哥不能死，中间兄弟不能断;
​   索引列上少计算，范围之后全失效;
​   LIKE百分写最右，覆盖索引不写星;
​   不等空值还有or，索引失效要少用;
​   VAR引号不可丢，SQL高级也不难!</p>
<p>例子：</p>
<p><figure class="pswp-item" style="flex: 127.46478873239437" data-width="724" data-height="284"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/6a22c90a5f9e338160ca39b7255acbef.png" alt="" /></figure></p>
<h2>Sql 语句中 IN 和 EXISTS 的区别及应用</h2>
<p>student表</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`stuid`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;学号&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`stunm`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;学生姓名&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`stuid`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of student</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;张三&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;李四&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;赵二&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;王五&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;刘青&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;周明&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`student`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1007&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;吴七&#39;</span><span class="p">);</span>
</pre></div>
<p>score表</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`stuid`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`courseno`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`scores`</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`stuid`</span><span class="p">,</span><span class="n n-Quoted">`courseno`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of score</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;67&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;87&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;83&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;88&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;77&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;77&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;68&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;88&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;84&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;89&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;78&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;78&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;69&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;89&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;85&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;90&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;79&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;79&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;70&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;90&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;86&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;91&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;80&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;80&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;71&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;91&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;87&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;92&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;81&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;81&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;72&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;92&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;88&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;93&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;82&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`score`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;82&#39;</span><span class="p">);</span>
</pre></div>
<p>course表</p>
<div class="highlight"><pre><span></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="p">;</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n n-Quoted">`courseno`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n n-Quoted">`coursenm`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n n-Quoted">`courseno`</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="o">=</span><span class="s1">&#39;课程表&#39;</span><span class="p">;</span>

<span class="c1">-- ----------------------------</span>
<span class="c1">-- Records of courses</span>
<span class="c1">-- ----------------------------</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C001&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;大学语文&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C002&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;新视野英语&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C003&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;离散数学&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C004&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;概率论与数理统计&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C005&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;线性代数&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C006&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;高等数学(一)&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n n-Quoted">`courses`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;C007&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;高等数学(二)&#39;</span><span class="p">);</span>
</pre></div>
<p>补充：SQL语句执行顺序详见：<a href="https://blog.csdn.net/wqc19920906/article/details/79411854">SQL语句执行顺序</a></p>
<h3>IN 语句：只执行一次</h3>
<p>确定给定的值是否与子查询或列表中的值相匹配。in在查询的时候，首先查询子查询的表，然后将内表和外表做一个笛卡尔积，然后按照条件进行筛选。所以相对内表比较小的时候，in的速度较快。</p>
<p>具体sql示例：</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stuid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">stuid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">stuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stuid</span><span class="p">)</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 55.88235294117647" data-width="247" data-height="221"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/4f4916684820eb253733a0241388ad90.png" alt="" /></figure></p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stuid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">stuid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">stuid</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1005</span><span class="p">)</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 52.87356321839081" data-width="184" data-height="174"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/13307a1b359144618aeae7c2e57c9a31.png" alt="" /></figure></p>
<p>以上两个语句的执行流程：</p>
<p>首先会执行from语句找出student表，然后执行 in 里面的子查询，再然后将查询到的结果和原有的user表做一个笛卡尔积，再根据的 student.stuid IN score.stuid 的条件，将结果进行筛选（既比较stuid列的值是否相等，将不相等的删除）。最后得到符合条件的数据。</p>
<h3>EXISTS语句：执行student.length次</h3>
<p>指定一个子查询，检测行的存在。遍历循环外表，然后看外表中的记录有没有和内表的数据一样的。匹配上就将结果放入结果集中。</p>
<p>EXISTS 语法：</p>
<p>SELECT ... FROM table WHERE EXISTS(subquery)</p>
<p>理解：将主查询的数据放到子查询中做条件验证，根据验证结果（TRUE或者FALSE）来决定朱查询的数据结果是否得意保留。相当于从表A和B中取出交集，然后再从A表中取出所在交集的部分数据，当然后面加WHERE条件还可以进一步筛选。</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">stuid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">stuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">stuid</span><span class="p">)</span>
</pre></div>
<p>这条sql语句的执行结果和上面的in的第一条执行结果是一样的。</p>
<p>但是，不一样的是它们的执行流程完全不一样：</p>
<p>　　使用exists关键字进行查询的时候，首先，先查询的不是子查询的内容，而是查的主查询的表，也就是说，先执行的sql语句是：</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="n">s</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 55.6" data-width="278" data-height="250"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/605a25566c74143dfd27c97534313339.png" alt="" /></figure></p>
<p>如果成立则返回true不成立则返回false。如果返回的是true的话，则该行结果保留，如果返回的是false的话，则删除该行，最后将得到的结果返回。</p>
<h3>IN和EXISTS的区别及应用场景</h3>
<p>​   如果子查询得出的结果集记录较少，主查询中的表较大且又有索引时应该用 in , 反之如果外层的主查询记录较少，子查询中的表大，又有索引时使用 exists 。其实区分 in 和 exists 主要是造成了驱动顺序的改变(这是性能变化的关键)，如果是 exists ，那么以外层表为驱动表，先被访问，如果是 in ，那么先执行子查询，所以会以驱动表的快速返回为目标，那么就会考虑到索引及结果集的关系了 ，另外 in 时不对NULL进行处理。</p>
<p>​   in 是把外表和内表作 hash 连接，而exists是对外表作loop循环，每次loop循环再对内表进行查询。一直以来认为exists比in效率高的说法是不准确的。</p>
<p><strong>not in 和not exists</strong></p>
<p>​   如果查询语句使用了not in 那么内外表都进行全表扫描，没有用到索引；而not extsts 的子查询依然能用到表上的索引。所以无论那个表大，用not exists都比not in要快。</p>
<h2>查询优化</h2>
<h3>1.原则</h3>
<h4>1.小表驱动大表，即小的数据集驱动大的数据集。</h4>
<p>​   数据库最伤神的就是跟程序链接释放，第一个建立了10000次链接，第二个建立了50次。假设链接了两次，每次做上百万次的数据集查询，查完就走，这样就只做了两次；相反建立了上百万次链接，申请链接释放反复重复，这样系统就受不了了。
这时候就诞生了in 和exists的对比。</p>
<p><strong>in</strong></p>
<p>这里假设A表代表员工表，B表代表部门表。
假设部门只有三个，销售、技术部、行政部，言下之意是在这三个部门里的所有员工都查出。</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">B</span><span class="p">);</span>
</pre></div>
<p>等价于：</p>
<p>先循环</p>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">B</span>
</pre></div>
<p>比如一个公司有5个部门，但是华为的员工少说有15W-20W，员工总不能比部门多吧，1个员工不能有10-20几个部门吧，这时候就相当于得到了小表(部门表)；</p>
<p>后循环：</p>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span>
</pre></div>
<p><strong>相当于A.id等B表里面的，相当于从部门表获得对应的id。</strong></p>
<p><strong>当B表的数据集必须小于A表的数据集时，用in优于exists。</strong>
反之</p>
<div class="highlight"><pre><span></span><span class="n">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="p">(</span><span class="n">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span><span class="p">);</span><span class="w"> </span>
<span class="cp"># 这里的select 1并不绝对，可以写为select &#39;X&#39;或者&#39;A&#39;,&#39;B&#39;,&#39;C&#39;都可以，只要是常量就可以。</span>
</pre></div>
<p>等价于：</p>
<p>先循环</p>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span>
</pre></div>
<p>后循环</p>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">B</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">.</span><span class="n">id</span>
</pre></div>
<p>这样exists就会变成看看A表是否存在于(select 1 from B where B.id = A.id)里面，这个查询返回的是TRUE或者FALSE的BOOL值，简单来说就是要当A表的数据集小于B表的数据集时，用exists优于in。</p>
<p>要注意的是：A表与B表的ID字段应该建立索引。</p>
<p><strong>EXISTS</strong></p>
<p>语法：EXISTS</p>
<p>SELECT ... FROM table WHERE EXISTS(subquery)。</p>
<p>理解：将主查询的数据放到子查询中做条件验证，根据验证结果（TRUE或者FALSE）来决定朱查询的数据结果是否得意保留。</p>
<p>相当于从表A和B中取出交集，然后再从A表中取出所在交集的部分数据，当然后面加WHERE条件还可以进一步筛选。</p>
<p>补充：</p>
<p>SQL语句执行顺序详见：<a href="https://blog.csdn.net/wqc19920906/article/details/79411854">SQL语句执行顺序</a></p>
<ol>
<li>EXISTS(subquery)只返回TRUE或者FALSE，因此子查询中的SELECT * 也可以是SELECT 1 或者SELECT 'X'，官方说法是实际执行时会忽略SELECT清单，因此没有区别。</li>
<li>EXISTS子查询的实际执行过程可能经过了优化而不是理解上的逐条对比，如果担忧效率问题，可进行实际校验。</li>
<li>EXISTS子查询旺旺可以用条件表达式，其他子查询或者JOIN来替代，何种最优需要具体问题具体分析。</li>
</ol>
<p><strong>如果查询的两个表大小相当，那么用in和exists差别不大。</strong></p>
<p>延伸举例巩固：</p>
<p>如果两个表中一个较小，一个是大表，则子查询表大的用exists，子查询表小的用in：
例如：表A（小表），表B（大表）</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="c1"># 效率低，用到了A表上cc列的索引；</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">exists</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">cc</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">cc</span><span class="o">=</span><span class="n">A</span><span class="p">.</span><span class="n">cc</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">  </span><span class="c1"># 效率高，用到了B表上cc列的索引。</span>
</pre></div>
<p>相反的</p>
<div class="highlight"><pre><span></span>select * from B where cc in (select cc from A) ;  # 效率高，用到了B表上cc列的索引；
select * from B where exists(select cc from A where cc=B.cc) ;  # 效率低，用到了A表上cc列的索引。
</pre></div>
<p>not in 和not exists如果查询语句使用了not in 那么内外表都进行全表扫描，没有用到索引；而not extsts 的子查询依然能用到表上的索引。所以无论那个表大，用not exists都比not in要快。</p>
<p>例：</p>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_01.png" alt="" /></figure></p>
<h4>2.Order By关键字优化</h4>
<p>Order By子句，尽量使用Index方式排序,避免使用FileSort方式排序 。</p>
<p>尽可能在索引列上完成排序操作，遵照索引的最佳左前缀。</p>
<p><strong>提高Order By的速度:</strong></p>
<ol>
<li><p>Order by时, select * 是一个大忌,应该只 select 需要的字段，这点非常重要。在这里的影响是:</p>
<ul>
<li><p>当Query的字段大小总和小于max_length_for_sort_data而且排序字段不是TEXT 或者 BLOB类型时，会用改进后的算法——单路排序，否则用老算法——多路排序。</p>
</li>
<li><p>两种排序算法的数据都有可能超出sort_buffer的容量，超出之后，会创建tmp文件进行合并排序，导致多次IO，但是用单路排序算法的风险会更大一些,所以需要提高sort_buffer_size。</p>
</li>
</ul>
</li>
<li><p>尝试提高 sort_buffer_size (排序缓冲区大小)</p>
<p>不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。</p>
</li>
<li><p>尝试提高 max_length_for_sort_data (排序数据的最大长度)</p>
<p>提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高磁盘I/O活动和低CPU使用率。</p>
</li>
</ol>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_02.png" alt="" /></figure></p>
<h4>3.Group By关键字优化</h4>
<p>与Order By相似。</p>
<ul>
<li><p>group by实质是先排序后进行分组，遵照索引建的最佳左前缀。</p>
</li>
<li><p>当无法使用索引列，增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置。</p>
</li>
<li><p>where高于having，能写在where限定的条件就不要去having限定了。</p>
</li>
</ul>
<h3>2.流程</h3>
<ol>
<li>慢查询的开启并捕获</li>
<li>explain + 慢SQL分析</li>
<li>show profile 查询SQL在MySQL服务器里面的执行细节和生命周期情况</li>
<li>SQL数据库服务器的参数调优。</li>
</ol>
<h2>慢查询日志</h2>
<blockquote><p><a href="https://dev.MySQL.com/doc/refman/8.0/en/slow-query-log.html">https://dev.MySQL.com/doc/refman/8.0/en/slow-query-log.html</a></p>
</blockquote>
<h3>1.说明</h3>
<p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具
体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</p>
<p>具体指运行时间超过Iong_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行时间大于10秒的语句。</p>
<p>由它来查看哪些SQL超出了的最大忍耐时间值，再结合 explain 进行全面分析。</p>
<h3>2.使用</h3>
<p>默认MySQL没有开启慢查询，需要说动设置这个参数。当然，如果不是调优需要的话，一般不建议开启该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志写入文件。</p>
<p>查看是否开启  <code>SHOW GLOBAL VARIABLES LIKE 'slow_query_log%'</code>。</p>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_03.png" alt="" /></figure></p>
<p>上面查询结果第一行，这里是开启的，第二行是默认查询路径文件名。</p>
<p>补充：如果通过终端命令设定的话，再查询是看不到修改结果的，需要新开启一个窗口查看即可。如果要永久生效，必须修改my.cnf配置文件(其他系统变量也是如此)。</p>
<p>要明确指定初始慢查询日志状态，请使用 <code>SET GLOBAL slow_query_log = 1 | 0</code>。</p>
<p>使用<code>`SET GLOBAL slow_query_log = 1</code>开启慢查询日志只对当前数据库生效，MySQL重启后便会失效。</p>
<p>那么开启了慢日志后，怎么样的SQL才会记录到慢查询当中呢？</p>
<p>这个是由参数<code>long_query_time</code>控制，默认情况下<code>long_query_time</code>的值是10秒。
查看:<code>SHOW GLOBAL VARIABLES LIKE 'long_query_time';</code></p>
<p>假如SQL运行时间刚好等于long_query_time的情况，并不会被记录下来，也就是说，在MySQL源码里是判断<strong>大于<code>long_query_time</code>，而非大于等于</strong>。</p>
<p>设置:<code>SET GLOBAL long_query_time = 3</code>。</p>
<ul>
<li><p>记录慢SQL并后续分析：select sleep(4);</p>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_04.png" alt="1598601396920" /><figcaption>1598601396920</figcaption></figure></p>
</li>
<li><p>查看当前系统中多少条满记录：<code>show global status like '%Slow_queries%';</code></p>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="..\static\笔记图片\2020-08-27-MySQL优化相关_05.png" alt="" /></figure></p>
</li>
</ul>
<p><strong>配置版</strong></p>

<pre><code>show_query_log = 1;
show_query_log_file=/var/lib/MySQL/MySQL_slow.log
log_query_time=3;
log_output=FILE</code></pre>
<h3>3.日志分析工具MySQLdumpslow</h3>
<p>在生产环境中，如果要手动分析日志，查找、分析SQL，显然是一个体力活，MySQL提供了日志分析工具MySQLdumpslow。</p>
<p>上面测试的慢查询SQL只有一条，假如在实际的生产环境中，慢查询SQL远远高于测试的数量，十几条甚至几十条，假如几条慢查询出现的频率很高，能做到根据轻重优先级来分析并排除那是不是更好？那么就用到了MySQLdumpslow。</p>

<pre><code>[root@lig MySQL]# MySQLdumpslow --help   ----------------------------------------------//执行命令
Usage: MySQLdumpslow [ OPTS... ] [ LOGS... ]

Parse and summarize the MySQL slow query log. Options are

  --verbose    verbose
  --debug      debug
  --help       write this text to standard output

  -v           verbose
  -d           debug
  -s ORDER     what to sort by (al, at, ar, c, l, r, t), 'at' is default
                al: average lock time
                ar: average rows sent
                at: average query time
                 c: count
                 l: lock time
                 r: rows sent
                 t: query time  
  -r           reverse the sort order (largest last instead of first)
  -t NUM       just show the top n queries
  -a           don't abstract all numbers to N and strings to 'S'
  -n NUM       abstract numbers with at least n digits within names
  -g PATTERN   grep: only consider stmts that include this string
  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),
               default is '*', i.e. match all
  -i NAME      name of server instance (if using MySQL.server startup script)
  -l           don't subtract lock time from total time</code></pre>
<p>s：表示按照何种方式排序</p>
<p>c：访问次数</p>
<p>i：锁定时间</p>
<p>r：返回记录</p>
<p>t：查询时间</p>
<p>al：平均锁定时间</p>
<p>ar：平均返回记录数</p>
<p>at：平均查询时间</p>
<p>t：即为返回前面多少条数据</p>
<p>g：后边搭配一个正则匹配模式，大小写不敏感</p>
<p>例：</p>

<pre><code>MySQLdumpslow -s r -t 10 /data/MySQL/MySQL-slow.log  //得到返回记录集最多的10个SQL
MySQLdumpslow -s c -t 10 /data/MySQL/MySQL-slow.log //得到访问次数最多的10个SQL 
MySQLdumpslow -s t -t 10 -g "left join" /data/MySQL/MySQL-slow.log  //得到按照时间排序的前10条里面含有做了连接的查询SQL
MySQLdumpslow -s r -t 10 /data/MySQL/MySQL-slow.log | more  //另外建议在使用这些命令时结合|和more使用，否则有可能出现爆屏情况</code></pre>
<h1>MySQL查询优化(3)-show profile</h1>
<p>如果想要进行SQL查询的数据调优、排查。</p>
<p>第一步，一定要让出现的问题重现啊(运营工程师或DBA他们从监控系统里面，收到了爆炸，系统变慢了，大家都知道，重要的核心系统都会有另外一套辅助的系统来监控，这种监控系统，比如说现在这个系统慢与每一个模块平均时间，可能5秒钟就能执行完，但是已经长达20秒了，这个时候就要判断为什么慢了。</p>
<p>有很多种可能的原因：可能是程序的内存泄漏，可能是死锁，可能是网络，可能是SQL写的烂。</p>
<p>假设是SQL的问题，那么需要把有问题的SQL抓出来</p>
<p>执行过程：</p>
<ol>
<li>收到问题，诊断SQL</li>
<li>开启慢查询日志，抓出执行的慢的SQL</li>
<li>使用explain分析（基本上可以找到为题所在，但是如果还是没有摆平，SQL在传输、网络、连接、死锁，需要进一步细粒度的查询和排查的时候就需要使用show profile）</li>
<li>show profile（还是解决的一般般）</li>
<li>配合DBA 到my.cnf配置文件中对各种性能的参数调优和修改(基本上是DBA修改)</li>
</ol>
<h2>show profile</h2>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/show-profile.html">MySQL 8.0参考手册-show profile</a></p>
<p>是什么：是mysql 提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量。（默认情况下，参数处于关闭状态，并保存最近15次的运行结果）</p>
<p>分析步骤：</p>
<ol>
<li><p>是否支持，看看当前的MySQL版本是否支持:</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;profiling&#39;</span><span class="p">;</span>
<span class="w"> </span><span class="c1">#或</span>
<span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;profiling%&#39;</span><span class="p">;</span>
</pre></div>
</li>
<li><p>开启功能，默认是关闭，使用前需要开启:</p>
<div class="highlight"><pre><span></span><span class="k">set</span><span class="w"> </span><span class="n">profiling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">on</span><span class="p">;</span>
</pre></div>
</li>
<li><p>运行sql</p>
<p>随便运行几条SQL，以便于show prifiles的日志分析。</p>
</li>
<li><p>查询结果</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">profiles</span><span class="p">;</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 94.5578231292517" data-width="1112" data-height="588"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/d7b7871622ba995c7ad16bb1f2cbb95e.png" alt="" /></figure></p>
</li>
<li><p>诊断SQL</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">profile</span><span class="w"> </span><span class="k">cpu</span><span class="p">,</span><span class="w"> </span><span class="k">block</span><span class="w"> </span><span class="k">io</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">query</span><span class="w"> </span><span class="err">[</span><span class="n">上一步的Query_ID</span><span class="err">]</span><span class="p">;</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 63.71473354231975" data-width="813" data-height="638"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/0f37e83a461cfc5cea96d84f7d3b0432.png" alt="" /></figure></p>
<p>从图中可以看到开始，打开表，加载，关闭表，释放资源、记录日志，清理工作，在这儿可以看到一条SQL执行的完整生命周期。</p>
<p><figure class="pswp-item" style="flex: 116.45021645021644" data-width="1076" data-height="462"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/fd2db3d168cdcca999dc993c99807b29.png" alt="" /></figure></p>
</li>
<li><p>开发中需要注意的问题</p>
<p>如果<code>show profile ... for query [Query_ID];</code>出现了如下四个，则必须优化这条sql。</p>
<ul>
<li><strong>converting HEAP to MyISAM</strong> : 查询结果太大， 内存都不够用了，会往磁盘上搬了</li>
<li><strong>Creating tmp table</strong> : 创建临时表<ol>
<li>拷贝数据到临时表: 假设要查询两百万数据，刚好匹配的条件有一百万，恰巧要把这一百万的数据拷贝到临时表，然后再把数据推送给用户，最后再把临时表删掉，这种情况就是导致SQL变慢的罪魁祸首</li>
<li>用完再删除</li>
</ol>
</li>
<li><strong>Copying to tmp table on disk</strong> : 把内存中临时表复制到磁盘</li>
<li><strong>locked</strong></li>
</ul>
</li>
</ol>
<h1>MySQL查询优化(4)-全局查询日志</h1>
<p>show profile可以帮记录下来了后台执行过得SQL，全局查询日志有时也能帮助来调SQL。但是，切记，这个全局查询日志只能在<strong>测试环境</strong>使用，绝不可以在生产环境使用（公司中一般都是生产环境、测试环境分离，但是测试环境一般都不如生产环境，或多或少会有些差距，但是大部分的SQL正常来说在部到生产之前会在测试上先跑一遍甚至几遍）。</p>
<p>切记：<strong>永远不要再生产环境开启全局查询日志这个功能</strong>。</p>
<p>配置方式启用:</p>
<p>在MySQL的配置文件中，配置如下：</p>
<div class="highlight"><pre><span></span><span class="c1">#开启</span>
<span class="n">general_log</span><span class="o">=</span><span class="mi">1</span>
<span class="c1">#记录日志文件的路径</span>
<span class="n">general_log_file</span><span class="o">=/</span><span class="k">path</span><span class="o">/</span><span class="k">logfile</span>
<span class="c1">#输出格式</span>
<span class="n">log_output</span><span class="o">=</span><span class="k">file</span>
</pre></div>
<p>命令方式启用:</p>
<div class="highlight"><pre><span></span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">general_log</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">#开启后会把所有的SQL进行记录</span>
<span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">log_output</span><span class="o">=</span><span class="s1">&#39;TABLE&#39;</span><span class="p">;</span>
</pre></div>
<p>此后所编写的SQL语句，将会记录到MySQL库里的general_log表，可以用下面的命令查看。</p>
<div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">general_log</span><span class="p">;</span>
</pre></div>
<p>如果需要做系统的定案分析(如：今天下午2点-3点出现的故障），如果要观察和复现的话，可以在测试环境下模拟一遍，然后把所有的问题复现一下。</p>
<p>然后用<code>general_log</code>这个表来查看什么时间段发生了什么样的SQL，帮助定位问题。</p>
<h1>MySQL锁机制</h1>
<h3>概述</h3>
<p>锁是计算机协调多个进程或线程并发访问某一资源的机制(说白了就是防止争抢)。</p>
<blockquote><p>打个比方，在淘宝上买一件商品，商品只有一个库存，这个时候如果还有另一个人购买，那么如何解决是你买到还是另一个人买到的问题？
这里肯定要用到事务，先从库存表中取出物品数量，然后插入订单，付款后插入付款表信息，然后更新商品数量，在这个过程中，使用锁可以对有限的资源进行保护，解决隔离和并发的矛盾。</p>
</blockquote>
<p>在数据库中，除传统的计算资源(如CPU、RAM、I/O等)的争用意外，数据也是一种供 许多用户共享的资源，如何保证数据并发访问的一致性，有效性是所有数据库必须解决的一个问题。锁充足也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言闲的尤其重要，也更加复杂。</p>
<h3>锁的分类</h3>
<ul>
<li>从对数据操作的类型（读/写）分</li>
</ul>
<p>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</p>
<p>写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</p>
<p>从对数据操作的粒度分(表锁、行锁)</p>
<p>开销、加锁速度、死锁、粒度、并发性能，只能就具体应用的特点来说哪种锁更合适</p>
<h4>1.表锁(偏读)</h4>
<p>偏向MyISAM存储引擎，开销小，加锁块；无死锁；锁定颗粒大，发生锁冲突的概率最高，并发度最低。</p>
<blockquote><p>开玩笑的说，早上来上班你第一个来的， 到公司就把大门给锁住了，把门禁电关了，整个公司现在你一个人独享，别人还能跟你冲突吗，并发度也就最低了。</p>
</blockquote>
<h5>1.案例分析(加读锁)</h5>
<ul>
<li>建表SQL</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">nul</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">auto_increment</span><span class="p">,</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">name</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">)</span><span class="k">engine</span><span class="w"> </span><span class="n">myisam</span><span class="p">;</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="k">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="k">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="k">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="k">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="k">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">mylock</span><span class="p">;</span>
</pre></div>
<p>加锁和解锁命令：</p>
<div class="highlight"><pre><span></span><span class="k">lock</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">表名1</span><span class="w"> </span><span class="k">read</span><span class="o">|</span><span class="k">write</span><span class="p">,</span><span class="w"> </span><span class="n">表名2</span><span class="w"> </span><span class="k">read</span><span class="o">|</span><span class="k">write</span><span class="p">;</span><span class="w"> </span><span class="c1">#加锁</span>
<span class="k">unlock</span><span class="w"> </span><span class="k">tables</span><span class="p">;</span><span class="w"> </span><span class="c1">#解锁</span>
</pre></div>
<ul>
<li>加读锁(共享锁)</li>
</ul>
<div class="highlight"><pre><span></span>lock table mylock read;
</pre></div>
<p>查看表上的锁：<a href="https://dev.mysql.com/doc/refman/8.0/en/show-open-tables.html">官方文档-show open tables</a></p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="k">tables</span><span class="p">;</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 95.87155963302752" data-width="1045" data-height="545"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/d529183b04f1a2dda47c410d3d24078f.png" alt="" /></figure></p>
<p><figure class="pswp-item" style="flex: 74.14500683994528" data-width="1084" data-height="731"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/68e216909f4ecd38f85861d7f1ddbe9a.png" alt="" /></figure></p>
<p><strong>加读锁后，读取自己可以，写自己以及读取本库中别的表都不可以，言下之意就是只要加了读锁，就必须要把这笔读的账清掉再去做别的事</strong>。</p>
<p><strong>总结</strong></p>
<p>(窗口1)获得表mylock的read锁定时：</p>
<ol>
<li>当前session(窗口1)可以进行查看该表记录操作；其它session也可查该表记录</li>
<li>当前session不能查看其它没有锁定的表(账没结)；其它session可以查询或更新其它非锁定的表</li>
<li>当前session插入或更新锁定表都会提示报错；其它session插入或更新锁定表都会一直阻塞等待获取表</li>
<li>当前session释放读锁时，其它session获得锁，执行插入或更新完成。</li>
</ol>
<h5>2.案例分析2(加写锁)</h5>
<p>当session1(窗口1)获得表mylock的write锁定时：</p>
<ol>
<li>当前session1对锁定都得表进行查询、更新操作都可以执行，其它session对锁定表的查询(更新操作也一样)被阻塞，需要等待锁被释放。（如果可以，请换成不同的id来进行测试，因为mysq有缓存，查询的多了，第二次的条件会从缓存获得，会影响锁效果演示）</li>
<li>当前sesison1释放锁，其它session获得锁，查询返回。</li>
</ol>
<h5>案例结论</h5>
<p>MyISAM在执行查询(SELECT)前，会自动给涉及查询(SELECT)的所有表加读锁，在执行增删改操作前，会自动给涉及增删改操作的表加写锁。</p>
<p>MySQL的表级结构有两种模式：</p>
<ul>
<li><p>表共享读锁（Table Read Lock）</p>
</li>
<li><p>表独占写锁（Table Write Lock）</p>
</li>
</ul>
<p><figure class="pswp-item" style="flex: 395.29411764705884" data-width="672" data-height="85"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/e15df19d0008aa6cbdad8fd469b58df0.png" alt="" /></figure></p>
<p>结论：</p>
<p>对MyISAM引擎的表进行操作，会有以下情况：</p>
<ol>
<li>对MyISAM表的读操作（加读锁），不会影响其他进行对同一表的读操作，但会阻塞同一表的写操作，只有当读锁释放后，才会执行其它进程的写操作。</li>
<li>对MyISAM表的写操作（加写锁），会阻塞其它进行对统一读和写操作，只有当锁释放后，才会执行其它进程的读写操作。</li>
</ol>
<p>简而简之，就是：<strong>读锁会阻塞写，但是不会阻塞读。而写锁则会把读和写都阻塞。</strong></p>
<p>补充：</p>
<p>如何分析表锁定</p>
<p>可以通过查看<code>table_locks_waited</code>和<code>table_locks_immediate</code>状态变量来分析系统上的表锁定。</p>
<p>SQL：</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">status</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;table%&#39;</span><span class="p">;</span>
</pre></div>
<p>这里会有几个变量来记录MySQL内部表级锁定的情况，其中最重要的两个变量说明如下：</p>
<ul>
<li><code>Table_locks_immediate</code>：产生表级锁定的次数，表示可以立即获取所的查询次数，每立即获取锁值</li>
<li><code>Table_locks_waited</code>：出现表级锁定征用而发生等待的次数（不能立即获取所的次数，每等待一次锁值加1），此值高则说明存在着较严重的表级锁征用情况。</li>
</ul>
<p>此外，MyISAM的读写锁调度是写优先，所以MyISAM不适合做写为主的表的引擎，因为加写锁后，其它线程不能做任何操作，大量的更新会使查询难得到锁，从而造成永远阻塞。</p>
<h4>2.行锁(偏写)</h4>
<p>行锁(偏向InnoDB存储引擎，开销大， 加锁慢，会出现死锁；锁定粒度最小，发生锁冲突的概率最低（假设100行，你用45行我用78行，两者无交集），并发度也最高。</p>
<blockquote><p>InnoDB与MyISAM的最大不同的两点：</p>
<ol>
<li>支持事务(TRANSACTION)；</li>
<li>采用了行级锁；</li>
</ol>
</blockquote>
<p>回顾：</p>
<p>事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。</p>
<ul>
<li><p>原子性（Atomicity)：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</p>
</li>
<li><p>一致性(Consistent)：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</p>
</li>
<li>隔离性（lsolation)：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li>
<li>持久性(Durable)：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li>
</ul>
<p>并发事务处理带来的问题：</p>
<ul>
<li><p>更新丢失(Lost Update)：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题——最后的更新<strong>覆盖了由其他事务所做的更新</strong>。</p>
</li>
<li><p>脏读(Dirty Reads)：事务A读取到了事务B<strong>已修改但尚未提交</strong>的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取的数据无效，不符合一致性要求。</p>
</li>
<li><p>不可重复读(Non-Repeatable Reads)：事务A读取到了<strong>事务B已经提交的修改数据</strong>，不符合隔离性。</p>
</li>
<li><p>幻读(Phantom Reads)：事务A读取到了<strong>事务B提交的新增数据</strong>，不符合隔离性。</p>
<p>脏读是事务B里面修改了数据，幻读是事务B里面新增了数据。</p>
</li>
</ul>
<p>事务隔离级别：</p>
<p><figure class="pswp-item" style="flex: 125.10917030567686" data-width="1719" data-height="687"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/8078334147c880fb78f8beb8b2f69c5c.png" alt="" /></figure></p>
<p>案例分析</p>
<ul>
<li>建表SQL</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
<span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="k">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;4000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;5000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;6000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;7000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;8000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="s1">&#39;9000&#39;</span><span class="p">);</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="n">valeus</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span>

<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">test_innodb_a_ind</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

<span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">test_innodb_lock_b_ind</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="p">;</span>
</pre></div>
<ul>
<li><p>行锁演示</p>
<p>MySQL5.5以后默认存储引擎为InnoDB，MySQL默认的数据提交操作模式是自动提交模式（autocommit），这就表示除非显式地开始一个事务，否则每个查询都被当做一个单独的事务自动执行。</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s2">&quot;autocommit&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">#查看自动提交状态</span>
<span class="k">set</span><span class="w"> </span><span class="n">autocommit</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">#关闭自动提交</span>
</pre></div>
</li>
</ul>
<p><strong>总结</strong></p>
<p>创建两个会话，先关闭 autocommit；（<code>set autocommit=0</code>）</p>
<ol>
<li>session1执行更新操作，没有手写commit；session2执行同一行数据的更新操作，会被阻塞。</li>
<li>session1提交commit更新；session2解除阻塞，更新正常进行。</li>
<li>session1与session2执行不同行的更新操作时，互不影响，不会发生等待阻塞情况</li>
<li>两者提交，数据显示正常。</li>
</ol>
<h5>索引失效行锁变表锁</h5>
<p>首先知道如果索引失效的情况下，那么肯定会导致索引失效，但是如果使用不当，会导致行锁变成表锁。</p>
<p>上文中数据库的存储引擎为InnoDB，并且关闭了自动提交，在创建表的时候创建了两个索引，分别在表中的a和b字段上建立了两个单值索引。如下</p>
<p><figure class="pswp-item" style="flex: 343.2835820895522" data-width="920" data-height="134"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/4d0a25eceaffc5149116205f4108a8f4.png" alt="" /></figure></p>
<p>看一下表信息</p>
<p><figure class="pswp-item" style="flex: 91.7624521072797" data-width="479" data-height="261"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/178aabaa1b71d9332ad765e341777baa.png" alt="" /></figure></p>
<p><em>其中，a为int型，b为varchar型</em></p>
<p>上文中说过，两个会话去执行不同的记录各不相干不会导致阻塞状态。</p>
<p>在讲索引优化的时候说过“var引号不能丢”，如果丢失，会导致索引失效。现在来模拟一下这种情况，上面说过b字段是varchar型，故意把它写错不加单引号。</p>
<p>MySQL底层是做了类型转换的，但是由于“b”列是做了索引的的一列，自动做了类型转换之后导致类型失效，此时在会话1中修改之后，自己自娱自乐了一番，完全不管会话2受得了受不了发生了阻塞。此时执行commit。</p>
<p>这种情况就是一个不小心就是，<strong>var没有加引号，导致索引失效，行锁边表锁。</strong></p>
<p><strong>没有索引或者索引失效时，InnoDB 的行锁变表锁</strong></p>
<p><strong>原因：Mysql 的行锁是通过索引实现的！</strong></p>
<h5>间隙锁危害</h5>
<p>当用<strong>范围条件</strong>而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但不存在的记录，叫做<strong>“间隙(GAP)”</strong>(宁可错杀不可放过，就算中间出现间隙，找不到指定的记录也会锁住)，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁(NEXT-KEY)锁。</p>
<p>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定值范围内的任何数据，在某些场景下这可能会针对性造成很大的危害。</p>
<blockquote><p>一般而言，为了云计算和大数据分析，数据最最好是连续的。每一个互联网公司的每一条数据都时很珍贵的，业务逻辑层所写的delete方法调用mapper层delete方法并没有从物理上把这条数据给切切实实的干掉。</p>
</blockquote>
<p>总结</p>
<ol>
<li>在会话1中执行范围操作并未提交事务；会话2产生阻塞，暂时不能插入；</li>
<li>会话1执行commit；会话2阻塞解除。</li>
</ol>
<h5>行锁总结</h5>
<p>InnoDB存储引擎由于事先了行级锁定，虽然在锁定机制的的实现方面，所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。当系统并发量较高的时候，InnoDB的整体性能和MyISAM相比就会有比较明显的优势了。</p>
<p>但是，InnoDB的行级锁定同样也有其脆弱的一面，当使用不当的时候，可能会让InnoDB的整体性能表现不仅不能比MyISAM高，甚至可能更差（就像前面说过的行锁可能变表锁）。</p>
<p>行锁分析：</p>
<p>通过检查 <code>InnoDB_row_lock</code> 状态变量来分析系统上的行锁的争夺情况</p>
<div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="k">status</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;innodb_row_lock%&#39;</span><span class="p">;</span>
</pre></div>
<p><figure class="pswp-item" style="flex: 109.5" data-width="438" data-height="200"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/943e40b7b9531d21af768ac39cd40b7c.png" alt="" /></figure></p>
<p>对各个状态量的说明如下：</p>
<ul>
<li><p><strong>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</strong></p>
</li>
<li><p>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</p>
</li>
<li><p>Innodb_row_lock_time_avg：每次等待锁花费平均时间；</p>
</li>
<li><p>Innodb_row_lock_time_max：从系统启动到现在等待最长的一次说话的时间；</p>
</li>
<li><p><strong>Innodb_row_lock_waits</strong> ：<strong>启动系统后到现在总共等待的次数；</strong></p>
</li>
</ul>
<p>对于5个状态变量，比较重要的是：</p>
<ul>
<li><p>Innodb_row_lock_time_avg（等待锁的平均时长）</p>
</li>
<li><p>Innodb_row_lock_waits （等待总次数）</p>
</li>
<li><p>Innodb_row_lock_time（等待总时长）</p>
</li>
</ul>
<p>尤其是当等待次数越高，而且每次等待时长也不小的时候，就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化计划。</p>
<p><strong>优化建议</strong></p>
<ul>
<li>尽可能在所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可能低级别事务隔离</li>
</ul>
<p>补充：</p>
<p>如何锁定一行？</p>
<p>在SQL语句后面加上<code>for update</code>，直到锁定行的会话提交commit。</p>
<p><figure class="pswp-item"  data-width="-1" data-height="-1" size-undefined><img src="C:\Users\Xuxx3309\AppData\Roaming\Typora\typora-user-images\1599154742368.png" alt="" /></figure></p>
<h4>3.页锁</h4>
<p>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</p>
<h1>MySQL主从复制</h1>
<h3>概念</h3>
<p>MySQL 主从复制是指数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL 默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，数据的更新可以在远程连接上进行，从节点可以复制主数据库中的所有数据库或者特定的数据库，或者特定的表。</p>
<h3>主要用途</h3>
<ul>
<li>读写分离
在开发工作中，有时候会遇见某个sql 语句需要锁表，导致暂时不能使用读的服务，这样就会影响现有业务，使用主从复制，让主库负责写，从库负责读，这样，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运作。</li>
<li>数据实时备份，当系统中某个节点发生故障时，可以方便的故障切换</li>
<li>高可用HA</li>
<li>架构扩展
随着系统中业务访问量的增大，如果是单机部署数据库，就会导致I/O访问频率过高。有了主从复制，增加多个数据存储节点，将负载分布在多个从节点上，降低单机磁盘I/O访问的频率，提高单个机器的I/O性能。</li>
</ul>
<h3>基本原理</h3>
<p>slave会从master读取binlog来进行数据同步。</p>
<p><figure class="pswp-item" style="flex: 92.0343137254902" data-width="751" data-height="408"><img src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/archives/assets/6c1dd0f7705093ffea629d7b36b16ecb.png" alt="" /></figure></p>
<p>三步：</p>
<ol>
<li>master将改变记录到二进制日志(binary log）。这些记录过程叫做二进制日志事件，binary log events;</li>
<li>slave将master的binary log events拷贝到它的中继日志（relay log） ;</li>
<li>slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的。</li>
</ol>
<h3>基本原则</h3>
<ol>
<li><p>每个slave只有一个master</p>
</li>
<li><p>每个slave只能有一个唯一的服务器ID</p>
</li>
<li><p>每个master可以有多个salve</p>
<p>复制的最大问题是<strong>延迟</strong>。</p>
</li>
</ol>
<h3>一主一从常见配置</h3>
<p><a href="https://www.bilibili.com/video/BV12b411K7Zu?p=241">参考</a></p>

            </div>
        </article>
        <div id="ga-tags">
    
    <span class="ga-tag">
        <a class="ga-highlight" href="/Xuxx_Blogs/tag/MySQL/">#MySQL</a>
    </span>
    
</div>
    </section>

    
<section id="ga-content_pager">

    <div class="next">
        <a class="ga-highlight" href="/Xuxx_Blogs/archives/bj28/">图解 Java 内存模型</a>
        <p class="yue">笔记</p>
    </div>


    <div class="prev">
        <a class="ga-highlight" href="/Xuxx_Blogs/archives/bj25/">Spring Boot发送邮件</a>
        <p class="yue">笔记</p>
    </div>

</section>


    

</main>

                <footer class="ga-mono" id="ga-footer">
                    <section>
                        <span id="ga-uptime"></span>
                        <span class="brand">Xuxx - 个人博客</span>
                    </section>
                    <section>
                        <p class="copyright">
                            <span>Copyright © 2024 Xuxx</span>
                            <span>Powered by <a no-style href="https://github.com/AlanDecode/Maverick" target="_blank">Maverick & Galileo</a></span>
                        </p>
                        <div class="copyright">
                            <span class="footer-addon">
                                
                            </span>
                            <nav class="social-links">
                                <ul><li><a class="no-style" title="Twitter" href="https://twitter.com/xuxx3309" target="_blank"><i class="gi gi-twitter"></i>Twitter</a></li><span class="separator">·</span><li><a class="no-style" title="GitHub" href="https://github.com/QQ1820582487" target="_blank"><i class="gi gi-github"></i>GitHub</a></li></ul>
                            </nav>
                        </div>
                    </section>
                    <script>
                        var site_build_date = "2019-12-26T02:30+08:00"
                    </script>
                    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/galileo-d8a0a06eff.js"></script>
                </footer>
            </div>
        </div>
    </div>
        
        
        <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <button class="pswp__button pswp__button--share" title="Share"></button>
                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                          <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                          </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div> 
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/ExSearch/ExSearch-493cb9cd89.js"></script>
    
    <!--katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/katex.min.js"></script>
    <script>
    mathOpts = {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    };
    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/qq1820582487/Xuxx_Blogs@gh-pages/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
    </body>
</html>